<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualizador GIFT de Moodle (con soporte mlang)</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f4f4f4;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: linear-gradient(135deg, #f7931e 0%, #ff6900 100%);
            color: white;
            padding: 30px;
            border-radius: 8px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            position: relative;
        }

        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.95;
            font-size: 1.1em;
        }

        .language-selector {
            position: absolute;
            top: 15px;
            right: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .language-selector label {
            color: white;
            font-weight: 600;
            font-size: 0.9em;
        }

        .language-selector select {
            padding: 8px 12px;
            border: 2px solid white;
            border-radius: 4px;
            background: white;
            color: #333;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .language-selector select:hover {
            background: #f8f9fa;
        }

        .language-selector select:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(255,255,255,0.3);
        }

        .input-section {
            background: white;
            padding: 25px;
            border-radius: 8px;
            margin-bottom: 30px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .input-section h2 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.4em;
        }

        textarea {
            width: 100%;
            min-height: 200px;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            resize: vertical;
            transition: border-color 0.3s;
        }

        textarea:focus {
            outline: none;
            border-color: #f7931e;
        }

        .button-group {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        button {
            background: #f7931e;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: background 0.3s;
        }

        button:hover {
            background: #e07d0e;
        }

        button.secondary {
            background: #6c757d;
        }

        button.secondary:hover {
            background: #5a6268;
        }

        .summary-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 25px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .summary-title {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .summary-item {
            background: rgba(255,255,255,0.2);
            padding: 15px;
            border-radius: 6px;
            backdrop-filter: blur(10px);
        }

        .summary-count {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .summary-label {
            font-size: 0.9em;
            opacity: 0.95;
        }

        .questions-container {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .question-card {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 5px solid #f7931e;
        }

        .question-header {
            background: #f8f9fa;
            padding: 15px 20px;
            border-bottom: 2px solid #e9ecef;
        }

        .question-number {
            color: #f7931e;
            font-weight: bold;
            font-size: 0.9em;
            text-transform: uppercase;
        }

        .question-title {
            color: #333;
            font-weight: 600;
            font-size: 1.1em;
            margin-top: 5px;
        }

        .question-type-badge {
            display: inline-block;
            background: #f7931e;
            color: white;
            padding: 4px 10px;
            border-radius: 3px;
            font-size: 0.75em;
            font-weight: 600;
            margin-top: 8px;
            text-transform: uppercase;
        }

        .question-body {
            padding: 20px;
        }

        .question-text {
            color: #333;
            font-size: 1.05em;
            margin-bottom: 20px;
            line-height: 1.7;
        }

        .answers-list {
            list-style: none;
        }

        .answer-item {
            background: #f8f9fa;
            padding: 12px 15px;
            margin-bottom: 10px;
            border-radius: 4px;
            border: 2px solid #e9ecef;
            display: flex;
            align-items: start;
            transition: all 0.3s;
        }

        .answer-item:hover {
            background: #e9ecef;
        }

        .answer-marker {
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 24px;
            height: 24px;
            border: 2px solid #6c757d;
            border-radius: 50%;
            margin-right: 12px;
            font-size: 12px;
            font-weight: bold;
            flex-shrink: 0;
        }

        .answer-marker.checkbox {
            border-radius: 3px;
        }

        .answer-item.correct {
            background: #d4edda;
            border-color: #28a745;
        }

        .answer-item.correct .answer-marker {
            background: #28a745;
            border-color: #28a745;
            color: white;
        }

        .answer-item.incorrect {
            background: #f8d7da;
            border-color: #dc3545;
        }

        .answer-item.incorrect .answer-marker {
            background: #dc3545;
            border-color: #dc3545;
            color: white;
        }

        .answer-item.partial {
            background: #fff3cd;
            border-color: #ffc107;
        }

        .answer-item.partial .answer-marker {
            background: #ffc107;
            border-color: #ffc107;
            color: white;
        }

        .answer-content {
            flex: 1;
        }

        .answer-text {
            color: #333;
            font-size: 1em;
        }

        .answer-feedback {
            margin-top: 8px;
            padding: 8px 12px;
            background: rgba(255,255,255,0.7);
            border-radius: 4px;
            font-size: 0.9em;
            color: #555;
            font-style: italic;
        }

        .answer-weight {
            display: inline-block;
            background: #6c757d;
            color: white;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 0.8em;
            margin-left: 8px;
            font-weight: 600;
        }

        .matching-pair {
            display: flex;
            align-items: center;
            gap: 15px;
            background: #f8f9fa;
            padding: 12px 15px;
            margin-bottom: 10px;
            border-radius: 4px;
            border: 2px solid #28a745;
        }

        .matching-question {
            flex: 1;
            font-weight: 600;
            color: #333;
        }

        .matching-arrow {
            color: #28a745;
            font-weight: bold;
            font-size: 1.2em;
        }

        .matching-answer {
            flex: 1;
            color: #555;
        }

        .numerical-answer {
            background: #d4edda;
            padding: 15px;
            border-radius: 4px;
            border: 2px solid #28a745;
        }

        .numerical-value {
            font-size: 1.2em;
            font-weight: bold;
            color: #28a745;
            margin-bottom: 8px;
        }

        .numerical-details {
            color: #555;
            font-size: 0.9em;
        }

        .essay-placeholder {
            background: #f8f9fa;
            padding: 20px;
            border: 2px dashed #6c757d;
            border-radius: 4px;
            text-align: center;
            color: #6c757d;
            font-style: italic;
        }

        .input-box {
            background: #f8f9fa;
            padding: 12px;
            border: 2px solid #6c757d;
            border-radius: 4px;
            min-height: 40px;
            color: #6c757d;
            font-style: italic;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 4px;
            border-left: 5px solid #dc3545;
            margin-bottom: 20px;
        }

        .info-box {
            background: #d1ecf1;
            color: #0c5460;
            padding: 15px;
            border-radius: 4px;
            border-left: 5px solid #17a2b8;
            margin-bottom: 20px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }

        .empty-state svg {
            width: 100px;
            height: 100px;
            opacity: 0.3;
            margin-bottom: 20px;
        }

        footer {
            margin-top: 60px;
            padding: 25px;
            background: linear-gradient(135deg, #333 0%, #555 100%);
            color: white;
            text-align: center;
            border-radius: 8px;
            box-shadow: 0 -4px 6px rgba(0,0,0,0.1);
        }

        footer p {
            margin: 8px 0;
            font-size: 0.95em;
        }

        footer a {
            color: #f7931e;
            text-decoration: none;
            font-weight: 600;
            transition: color 0.3s;
        }

        footer a:hover {
            color: #ff6900;
            text-decoration: underline;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.5em;
                padding-right: 0;
            }
            
            .question-card {
                border-left-width: 3px;
            }

            .matching-pair {
                flex-direction: column;
                align-items: start;
            }

            .matching-arrow {
                transform: rotate(90deg);
            }

            .language-selector {
                position: static;
                margin-top: 15px;
                justify-content: center;
            }

            .summary-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="language-selector">
                <label for="languageSelect" id="langLabel">üåê Idioma:</label>
                <select id="languageSelect" onchange="changeLanguage()">
                    <option value="es">Espa√±ol</option>
                    <option value="ca">Catal√†</option>
                    <option value="eu">Euskara</option>
                    <option value="gl">Galego</option>
                    <option value="en">English</option>
                    <option value="fr">Fran√ßais</option>
                    <option value="de">Deutsch</option>
                </select>
            </div>
            <h1 id="mainTitle">üìö Visualizador GIFT de Moodle (con soporte mlang)</h1>
            <p id="mainSubtitle">Visualiza tus preguntas en formato GIFT, incluyendo contenido multiling√ºe (mlang).</p>
        </div>

        <div class="input-section">
            <h2 id="inputTitle">Ingresa tu c√≥digo GIFT</h2>
            <textarea id="giftInput" placeholder=""></textarea>
            <div class="button-group">
                <button onclick="parseGIFT()" id="parseBtn">üîç Visualizar Preguntas</button>
                <button class="secondary" onclick="loadExample()" id="exampleBtn">üìù Cargar Ejemplo</button>
                <button class="secondary" onclick="clearAll()" id="clearBtn">üóëÔ∏è Limpiar</button>
            </div>
             <!-- Contenedor para el selector de idioma del contenido (mlang) -->
            <div id="contentLanguageSelectorContainer" style="display: none; margin-top: 20px; background: #eef2f5; padding: 15px; border-radius: 6px; border: 1px solid #ddd;">
                <p id="detectedLanguagesInfo" style="font-size: 0.9em; color: #555; margin-bottom: 10px;"></p>
                <label id="contentLangLabel" for="contentLanguageSelect" style="font-weight: 600; color: #333; margin-right: 10px;">üåç Ver pregunta en el idioma:</label>
                <select id="contentLanguageSelect" onchange="handleContentLanguageChange()" style="padding: 8px 12px; border-radius: 4px; border: 1px solid #ccc; font-size: 14px;"></select>
            </div>
        </div>

        <div id="output"></div>

        <footer>
            <p id="footerCreated">Creado por <strong>Jos√© Luis Miralles Bono</strong></p>
            <p><a href="https://www.jlmirall.es" target="_blank" rel="noopener noreferrer">www.jlmirall.es</a></p>
        </footer>
    </div>

    <script>
        // Traducciones
        const translations = {
            es: {
                mainTitle: 'üìö Visualizador GIFT de Moodle (con soporte mlang)',
                mainSubtitle: 'Visualiza tus preguntas en formato GIFT, incluyendo contenido multiling√ºe (mlang).',
                inputTitle: 'Ingresa tu c√≥digo GIFT',
                parseBtn: 'üîç Visualizar Preguntas',
                exampleBtn: 'üìù Cargar Ejemplo',
                clearBtn: 'üóëÔ∏è Limpiar',
                langLabel: 'üåê Idioma:',
                contentLangLabel: 'üåç Ver pregunta en el idioma:',
                detectedLangsLabel: 'Idiomas detectados:',
                footerCreated: 'Creado por',
                emptyTitle: 'No hay preguntas para mostrar',
                emptyText: 'Ingresa c√≥digo GIFT en el √°rea de texto superior',
                noQuestionsFound: 'No se encontraron preguntas v√°lidas en el c√≥digo GIFT proporcionado.',
                errorParsing: 'Error al procesar el c√≥digo GIFT:',
                questionsFound: 'Se encontraron',
                questions: 'pregunta(s)',
                summaryTitle: 'üìä Resumen de Preguntas',
                questionNumber: 'Pregunta',
                types: {
                    multipleChoice: 'Opci√≥n m√∫ltiple',
                    multipleResponse: 'Respuesta m√∫ltiple',
                    trueFalse: 'Verdadero/Falso',
                    shortAnswer: 'Respuesta corta',
                    matching: 'Emparejamiento',
                    numerical: 'Num√©rica',
                    essay: 'Ensayo'
                },
                typeLabels: {
                    multipleChoice: 'Opci√≥n m√∫ltiple',
                    multipleResponse: 'Respuesta m√∫ltiple',
                    trueFalse: 'Verdadero/Falso',
                    shortAnswer: 'Respuesta corta',
                    matching: 'Emparejamiento',
                    numerical: 'Num√©rica',
                    essay: 'Ensayo'
                },
                true: 'Verdadero',
                false: 'Falso',
                shortAnswerExpected: 'Respuesta de texto corto esperada',
                acceptedAnswers: 'Respuestas correctas aceptadas:',
                essayText: 'El estudiante debe escribir una respuesta tipo ensayo',
                essayManual: 'Esta pregunta requiere evaluaci√≥n manual',
                acceptedRange: 'Rango aceptado:',
                placeholder: 'Pega aqu√≠ tu c√≥digo GIFT...\n\nEjemplo:\n::Pregunta 1::¬øCu√°l es la capital de Francia?{\n=Par√≠s #¬°Correcto!\n~Londres #Incorrecto, esa es la capital de Inglaterra\n~Madrid #Incorrecto, esa es la capital de Espa√±a\n}\n\n::Pregunta 2::La tierra es plana.{F}'
            },
            ca: {
                mainTitle: 'üìö Visualitzador GIFT de Moodle (amb suport mlang)',
                mainSubtitle: 'Visualitza les teves preguntes en format GIFT, incloent-hi contingut multiling√ºe (mlang).',
                inputTitle: 'Introdueix el teu codi GIFT',
                parseBtn: 'üîç Visualitzar Preguntes',
                exampleBtn: 'üìù Carregar Exemple',
                clearBtn: 'üóëÔ∏è Netejar',
                langLabel: 'üåê Idioma:',
                contentLangLabel: 'üåç Veure pregunta en l\'idioma:',
                detectedLangsLabel: 'Idiomes detectats:',
                footerCreated: 'Creat per',
                emptyTitle: 'No hi ha preguntes per mostrar',
                emptyText: 'Introdueix codi GIFT a l\'√†rea de text superior',
                noQuestionsFound: 'No s\'han trobat preguntes v√†lides al codi GIFT proporcionat.',
                errorParsing: 'Error en processar el codi GIFT:',
                questionsFound: 'S\'han trobat',
                questions: 'pregunta/es',
                summaryTitle: 'üìä Resum de Preguntes',
                questionNumber: 'Pregunta',
                types: {
                    multipleChoice: 'Opci√≥ m√∫ltiple',
                    multipleResponse: 'Resposta m√∫ltiple',
                    trueFalse: 'Vertader/Fals',
                    shortAnswer: 'Resposta curta',
                    matching: 'Emparellament',
                    numerical: 'Num√®rica',
                    essay: 'Assaig'
                },
                typeLabels: {
                    multipleChoice: 'Opci√≥ m√∫ltiple',
                    multipleResponse: 'Resposta m√∫ltiple',
                    trueFalse: 'Vertader/Fals',
                    shortAnswer: 'Resposta curta',
                    matching: 'Emparellament',
                    numerical: 'Num√®rica',
                    essay: 'Assaig'
                },
                true: 'Vertader',
                false: 'Fals',
                shortAnswerExpected: 'Resposta de text curt esperada',
                acceptedAnswers: 'Respostes correctes acceptades:',
                essayText: 'L\'estudiant ha d\'escriure una resposta tipus assaig',
                essayManual: 'Aquesta pregunta requereix avaluaci√≥ manual',
                acceptedRange: 'Rang acceptat:',
                placeholder: 'Enganxa aqu√≠ el teu codi GIFT...\n\nExemple:\n::Pregunta 1::Quina √©s la capital de Fran√ßa?{\n=Par√≠s #Correcte!\n~Londres #Incorrecte, aquesta √©s la capital d\'Anglaterra\n~Madrid #Incorrecte, aquesta √©s la capital d\'Espanya\n}\n\n::Pregunta 2::La terra √©s plana.{F}'
            },
            eu: {
                mainTitle: 'üìö Moodle-ren GIFT Bistaratzailea (mlang-ekin bateragarria)',
                mainSubtitle: 'Bistaratu zure galderak GIFT formatuan, hizkuntza anitzeko edukia barne (mlang).',
                inputTitle: 'Sartu zure GIFT kodea',
                parseBtn: 'üîç Galderak Bistaratu',
                exampleBtn: 'üìù Adibidea Kargatu',
                clearBtn: 'üóëÔ∏è Garbitu',
                langLabel: 'üåê Hizkuntza:',
                contentLangLabel: 'üåç Galdera hizkuntza honetan ikusi:',
                detectedLangsLabel: 'Atzemandako hizkuntzak:',
                footerCreated: 'Egilea:',
                emptyTitle: 'Ez dago galderarik erakusteko',
                emptyText: 'Sartu GIFT kodea goiko testu eremuan',
                noQuestionsFound: 'Ez da galdera baliozkorik aurkitu emandako GIFT kodean.',
                errorParsing: 'Errorea GIFT kodea prozesatzean:',
                questionsFound: 'Aurkitu dira',
                questions: 'galdera',
                summaryTitle: 'üìä Galderen Laburpena',
                questionNumber: 'Galdera',
                types: {
                    multipleChoice: 'Aukera anitza',
                    multipleResponse: 'Erantzun anitza',
                    trueFalse: 'Egia/Gezurra',
                    shortAnswer: 'Erantzun laburra',
                    matching: 'Parekatzea',
                    numerical: 'Zenbakizkoa',
                    essay: 'Saiakera'
                },
                typeLabels: {
                    multipleChoice: 'Aukera anitza',
                    multipleResponse: 'Erantzun anitza',
                    trueFalse: 'Egia/Gezurra',
                    shortAnswer: 'Erantzun laburra',
                    matching: 'Parekatzea',
                    numerical: 'Zenbakizkoa',
                    essay: 'Saiakera'
                },
                true: 'Egia',
                false: 'Gezurra',
                shortAnswerExpected: 'Testu laburrezko erantzuna espero da',
                acceptedAnswers: 'Onartutako erantzun zuzenak:',
                essayText: 'Ikasleak saiakera moduko erantzun bat idatzi behar du',
                essayManual: 'Galdera honek eskuzko ebaluazioa behar du',
                acceptedRange: 'Onartutako tartea:',
                placeholder: 'Itsatsi hemen zure GIFT kodea...\n\nAdibidea:\n::Galdera 1::Zein da Frantziaren hiriburua?{\n=Paris #Zuzena!\n~Londres #Okerra, hori Ingalaterraren hiriburua da\n~Madril #Okerra, hori Espainiaren hiriburua da\n}\n\n::Galdera 2::Lurra laua da.{F}'
            },
            gl: {
                mainTitle: 'üìö Visualizador GIFT de Moodle (con soporte mlang)',
                mainSubtitle: 'Visualiza as t√∫as preguntas en formato GIFT, inclu√≠ndo contido multiling√ºe (mlang).',
                inputTitle: 'Introduce o teu c√≥digo GIFT',
                parseBtn: 'üîç Visualizar Preguntas',
                exampleBtn: 'üìù Cargar Exemplo',
                clearBtn: 'üóëÔ∏è Limpar',
                langLabel: 'üåê Idioma:',
                contentLangLabel: 'üåç Ver pregunta no idioma:',
                detectedLangsLabel: 'Idiomas detectados:',
                footerCreated: 'Creado por',
                emptyTitle: 'Non hai preguntas para mostrar',
                emptyText: 'Introduce c√≥digo GIFT na √°rea de texto superior',
                noQuestionsFound: 'Non se atoparon preguntas v√°lidas no c√≥digo GIFT proporcionado.',
                errorParsing: 'Erro ao procesar o c√≥digo GIFT:',
                questionsFound: 'Atop√°ronse',
                questions: 'pregunta(s)',
                summaryTitle: 'üìä Resumo de Preguntas',
                questionNumber: 'Pregunta',
                types: {
                    multipleChoice: 'Opci√≥n m√∫ltiple',
                    multipleResponse: 'Resposta m√∫ltiple',
                    trueFalse: 'Verdadeiro/Falso',
                    shortAnswer: 'Resposta curta',
                    matching: 'Emparellamento',
                    numerical: 'Num√©rica',
                    essay: 'Ensaio'
                },
                typeLabels: {
                    multipleChoice: 'Opci√≥n m√∫ltiple',
                    multipleResponse: 'Resposta m√∫ltiple',
                    trueFalse: 'Verdadeiro/Falso',
                    shortAnswer: 'Resposta curta',
                    matching: 'Emparellamento',
                    numerical: 'Num√©rica',
                    essay: 'Ensaio'
                },
                true: 'Verdadeiro',
                false: 'Falso',
                shortAnswerExpected: 'Resposta de texto curto esperada',
                acceptedAnswers: 'Respostas correctas aceptadas:',
                essayText: 'O estudante debe escribir unha resposta tipo ensaio',
                essayManual: 'Esta pregunta require avaliaci√≥n manual',
                acceptedRange: 'Rango aceptado:',
                placeholder: 'Pega aqu√≠ o teu c√≥digo GIFT...\n\nExemplo:\n::Pregunta 1::Cal √© a capital de Francia?{\n=Par√≠s #Correcto!\n~Londres #Incorrecto, esa √© a capital de Inglaterra\n~Madrid #Incorrecto, esa √© a capital de Espa√±a\n}\n\n::Pregunta 2::A terra √© plana.{F}'
            },
            en: {
                mainTitle: 'üìö Moodle GIFT Viewer (mlang supported)',
                mainSubtitle: 'Visualize your GIFT format questions, including multilingual content (mlang).',
                inputTitle: 'Enter your GIFT code',
                parseBtn: 'üîç Visualize Questions',
                exampleBtn: 'üìù Load Example',
                clearBtn: 'üóëÔ∏è Clear',
                langLabel: 'üåê Language:',
                contentLangLabel: 'üåç View question in language:',
                detectedLangsLabel: 'Detected languages:',
                footerCreated: 'Created by',
                emptyTitle: 'No questions to display',
                emptyText: 'Enter GIFT code in the text area above',
                noQuestionsFound: 'No valid questions found in the provided GIFT code.',
                errorParsing: 'Error processing GIFT code:',
                questionsFound: 'Found',
                questions: 'question(s)',
                summaryTitle: 'üìä Questions Summary',
                questionNumber: 'Question',
                types: {
                    multipleChoice: 'Multiple choice',
                    multipleResponse: 'Multiple response',
                    trueFalse: 'True/False',
                    shortAnswer: 'Short answer',
                    matching: 'Matching',
                    numerical: 'Numerical',
                    essay: 'Essay'
                },
                typeLabels: {
                    multipleChoice: 'Multiple choice',
                    multipleResponse: 'Multiple response',
                    trueFalse: 'True/False',
                    shortAnswer: 'Short answer',
                    matching: 'Matching',
                    numerical: 'Numerical',
                    essay: 'Essay'
                },
                true: 'True',
                false: 'False',
                shortAnswerExpected: 'Short text answer expected',
                acceptedAnswers: 'Accepted correct answers:',
                essayText: 'Student must write an essay-type answer',
                essayManual: 'This question requires manual evaluation',
                acceptedRange: 'Accepted range:',
                placeholder: 'Paste your GIFT code here...\n\nExample:\n::Question 1::What is the capital of France?{\n=Paris #Correct!\n~London #Incorrect, that\'s the capital of England\n~Madrid #Incorrect, that\'s the capital of Spain\n}\n\n::Question 2::The earth is flat.{F}'
            },
            fr: {
                mainTitle: 'üìö Visualiseur GIFT de Moodle (avec support mlang)',
                mainSubtitle: 'Visualisez vos questions au format GIFT, y compris le contenu multilingue (mlang).',
                inputTitle: 'Entrez votre code GIFT',
                parseBtn: 'üîç Visualiser les Questions',
                exampleBtn: 'üìù Charger l\'Exemple',
                clearBtn: 'üóëÔ∏è Effacer',
                langLabel: 'üåê Langue:',
                contentLangLabel: 'üåç Voir la question en langue :',
                detectedLangsLabel: 'Langues d√©tect√©es :',
                footerCreated: 'Cr√©√© par',
                emptyTitle: 'Aucune question √† afficher',
                emptyText: 'Entrez le code GIFT dans la zone de texte ci-dessus',
                noQuestionsFound: 'Aucune question valide trouv√©e dans le code GIFT fourni.',
                errorParsing: 'Erreur lors du traitement du code GIFT:',
                questionsFound: 'Trouv√©',
                questions: 'question(s)',
                summaryTitle: 'üìä R√©sum√© des Questions',
                questionNumber: 'Question',
                types: {
                    multipleChoice: 'Choix multiple',
                    multipleResponse: 'R√©ponse multiple',
                    trueFalse: 'Vrai/Faux',
                    shortAnswer: 'R√©ponse courte',
                    matching: 'Appariement',
                    numerical: 'Num√©rique',
                    essay: 'Essai'
                },
                typeLabels: {
                    multipleChoice: 'Choix multiple',
                    multipleResponse: 'R√©ponse multiple',
                    trueFalse: 'Vrai/Faux',
                    shortAnswer: 'R√©ponse courte',
                    matching: 'Appariement',
                    numerical: 'Num√©rique',
                    essay: 'Essai'
                },
                true: 'Vrai',
                false: 'Faux',
                shortAnswerExpected: 'R√©ponse texte courte attendue',
                acceptedAnswers: 'R√©ponses correctes accept√©es:',
                essayText: 'L\'√©tudiant doit √©crire une r√©ponse de type essai',
                essayManual: 'Cette question n√©cessite une √©valuation manuelle',
                acceptedRange: 'Plage accept√©e:',
                placeholder: 'Collez votre code GIFT ici...\n\nExemple:\n::Question 1::Quelle est la capitale de la France?{\n=Paris #Correct!\n~Londres #Incorrect, c\'est la capitale de l\'Angleterre\n~Madrid #Incorrect, c\'est la capitale de l\'Espagne\n}\n\n::Question 2::La terre est plate.{F}'
            },
            de: {
                mainTitle: 'üìö Moodle GIFT-Viewer (mit mlang-Unterst√ºtzung)',
                mainSubtitle: 'Visualisieren Sie Ihre GIFT-Format-Fragen, einschlie√ülich mehrsprachiger Inhalte (mlang).',
                inputTitle: 'Geben Sie Ihren GIFT-Code ein',
                parseBtn: 'üîç Fragen Visualisieren',
                exampleBtn: 'üìù Beispiel Laden',
                clearBtn: 'üóëÔ∏è L√∂schen',
                langLabel: 'üåê Sprache:',
                contentLangLabel: 'üåç Frage in Sprache anzeigen:',
                detectedLangsLabel: 'Erkannte Sprachen:',
                footerCreated: 'Erstellt von',
                emptyTitle: 'Keine Fragen anzuzeigen',
                emptyText: 'Geben Sie GIFT-Code im obigen Textbereich ein',
                noQuestionsFound: 'Keine g√ºltigen Fragen im bereitgestellten GIFT-Code gefunden.',
                errorParsing: 'Fehler beim Verarbeiten des GIFT-Codes:',
                questionsFound: 'Gefunden',
                questions: 'Frage(n)',
                summaryTitle: 'üìä Fragen-Zusammenfassung',
                questionNumber: 'Frage',
                types: {
                    multipleChoice: 'Multiple-Choice',
                    multipleResponse: 'Mehrfachantwort',
                    trueFalse: 'Wahr/Falsch',
                    shortAnswer: 'Kurzantwort',
                    matching: 'Zuordnung',
                    numerical: 'Numerisch',
                    essay: 'Aufsatz'
                },
                typeLabels: {
                    multipleChoice: 'Multiple-Choice',
                    multipleResponse: 'Mehrfachantwort',
                    trueFalse: 'Wahr/Falsch',
                    shortAnswer: 'Kurzantwort',
                    matching: 'Zuordnung',
                    numerical: 'Numerisch',
                    essay: 'Aufsatz'
                },
                true: 'Wahr',
                false: 'Falsch',
                shortAnswerExpected: 'Kurze Textantwort erwartet',
                acceptedAnswers: 'Akzeptierte richtige Antworten:',
                essayText: 'Der Student muss eine aufsatzartige Antwort schreiben',
                essayManual: 'Diese Frage erfordert eine manuelle Bewertung',
                acceptedRange: 'Akzeptierter Bereich:',
                placeholder: 'F√ºgen Sie hier Ihren GIFT-Code ein...\n\nBeispiel:\n::Frage 1::Was ist die Hauptstadt von Frankreich?{\n=Paris #Richtig!\n~London #Falsch, das ist die Hauptstadt von England\n~Madrid #Falsch, das ist die Hauptstadt von Spanien\n}\n\n::Frage 2::Die Erde ist flach.{F}'
            }
        };

        let currentLanguage = 'es';

        // --- INICIO: Variables globales para mlang ---
        let originalParsedQuestions = [];
        let detectedContentLanguages = new Set();
        let selectedContentLanguage = null;
        // --- FIN: Variables globales para mlang ---

        function detectBrowserLanguage() {
            const browserLang = navigator.language || navigator.userLanguage;
            const langCode = browserLang.split('-')[0];
            
            if (translations[langCode]) {
                currentLanguage = langCode;
            } else {
                currentLanguage = 'es'; 
            }
            
            document.getElementById('languageSelect').value = currentLanguage;
            updateUILanguage();
        }

        function changeLanguage() {
            currentLanguage = document.getElementById('languageSelect').value;
            updateUILanguage();
            if (originalParsedQuestions.length > 0) {
                filterAndDisplayQuestions();
            }
        }

        function updateUILanguage() {
            const t = translations[currentLanguage];
            
            document.getElementById('mainTitle').textContent = t.mainTitle;
            document.getElementById('mainSubtitle').textContent = t.mainSubtitle;
            document.getElementById('inputTitle').textContent = t.inputTitle;
            document.getElementById('parseBtn').textContent = t.parseBtn;
            document.getElementById('exampleBtn').textContent = t.exampleBtn;
            document.getElementById('clearBtn').textContent = t.clearBtn;
            document.getElementById('langLabel').textContent = t.langLabel;
            document.getElementById('giftInput').placeholder = t.placeholder;
            document.getElementById('contentLangLabel').textContent = t.contentLangLabel;
            
            const footerText = document.getElementById('footerCreated');
            footerText.innerHTML = `${t.footerCreated} <strong>Jos√© Luis Miralles Bono</strong>`;

            const infoEl = document.getElementById('detectedLanguagesInfo');
            if (detectedContentLanguages.size > 0) {
                const languages = Array.from(detectedContentLanguages).sort();
                infoEl.innerHTML = `<strong>${t.detectedLangsLabel}</strong> ${languages.join(', ')}`;
            }
        }
        
        // --- INICIO: Nuevas funciones para mlang ---

        function handleContentLanguageChange() {
            selectedContentLanguage = document.getElementById('contentLanguageSelect').value;
            filterAndDisplayQuestions();
        }

        function processMlangText(text, targetLang) {
            if (!text || typeof text !== 'string' || !targetLang) {
                return text;
            }

            const fullBlockRegex = /(?:\\\{mlang [a-zA-Z_\-]+\s*\\\}.*?\\\{mlang\\\})+/gs;

            return text.replace(fullBlockRegex, (fullBlock) => {
                const langSpecificRegex = /\\\{mlang ([a-zA-Z_\-]+)\s*\\\}(.*?)\\\{mlang\\\}/gs;
                const langs = {};
                let match;
                while ((match = langSpecificRegex.exec(fullBlock)) !== null) {
                    langs[match[1]] = match[2];
                }

                if (langs[targetLang]) {
                    return langs[targetLang];
                }
                const firstLang = Object.keys(langs)[0];
                return firstLang ? langs[firstLang] : ''; 
            });
        }

        function filterAndDisplayQuestions() {
            if (!originalParsedQuestions || originalParsedQuestions.length === 0) {
                document.getElementById('output').innerHTML = '';
                return;
            }

            if (!selectedContentLanguage || detectedContentLanguages.size === 0) {
                displayQuestions(originalParsedQuestions);
                return;
            }

            const filteredQuestions = JSON.parse(JSON.stringify(originalParsedQuestions));

            filteredQuestions.forEach(question => {
                question.title = processMlangText(question.title, selectedContentLanguage);
                question.text = processMlangText(question.text, selectedContentLanguage);

                if (question.answers) {
                    question.answers.forEach(answer => {
                        answer.text = processMlangText(answer.text, selectedContentLanguage);
                        if (answer.feedback) {
                            answer.feedback = processMlangText(answer.feedback, selectedContentLanguage);
                        }
                    });
                }
                if (question.pairs) {
                    question.pairs.forEach(pair => {
                        pair.question = processMlangText(pair.question, selectedContentLanguage);
                        pair.answer = processMlangText(pair.answer, selectedContentLanguage);
                    });
                }
            });

            displayQuestions(filteredQuestions);
        }

        function updateContentLanguageSelector() {
            const container = document.getElementById('contentLanguageSelectorContainer');
            const select = document.getElementById('contentLanguageSelect');
            const infoEl = document.getElementById('detectedLanguagesInfo');

            if (detectedContentLanguages.size > 0) {
                select.innerHTML = '';
                const languages = Array.from(detectedContentLanguages).sort();
                
                infoEl.innerHTML = `<strong>${translations[currentLanguage].detectedLangsLabel}</strong> ${languages.join(', ')}`;

                languages.forEach(lang => {
                    const option = document.createElement('option');
                    option.value = lang;
                    option.textContent = lang.toUpperCase();
                    select.appendChild(option);
                });
                
                selectedContentLanguage = languages[0];
                select.value = selectedContentLanguage;

                container.style.display = 'block';
            } else {
                selectedContentLanguage = null;
                infoEl.innerHTML = '';
                container.style.display = 'none';
            }
        }
        
        // --- FIN: Nuevas funciones para mlang ---

        function parseGIFT() {
            const input = document.getElementById('giftInput').value;
            const output = document.getElementById('output');
            const t = translations[currentLanguage];
            
            originalParsedQuestions = [];
            detectedContentLanguages.clear();
            selectedContentLanguage = null;

            if (!input.trim()) {
                output.innerHTML = `
                    <div class="empty-state">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        <h3>${t.emptyTitle}</h3>
                        <p>${t.emptyText}</p>
                    </div>
                `;
                updateContentLanguageSelector(); 
                return;
            }

            const langRegex = /\\\{mlang ([a-zA-Z_\-]+)\s*\\\}/g;
            let match;
            while ((match = langRegex.exec(input)) !== null) {
                detectedContentLanguages.add(match[1]);
            }
            
            updateContentLanguageSelector();

            try {
                originalParsedQuestions = parseGIFTFormat(input);
                
                if (originalParsedQuestions.length === 0) {
                    output.innerHTML = `<div class="error-message">${t.noQuestionsFound}</div>`;
                    document.getElementById('contentLanguageSelectorContainer').style.display = 'none';
                    return;
                }

                filterAndDisplayQuestions();

            } catch (error) {
                output.innerHTML = `<div class="error-message">${t.errorParsing} ${error.message}</div>`;
                document.getElementById('contentLanguageSelectorContainer').style.display = 'none';
            }
        }

        function parseGIFTFormat(text) {
            text = text.replace(/^\/\/.*$/gm, '');
            const questionBlocks = text.split(/\n\s*\n/).filter(block => block.trim());
            const questions = [];
            
            for (let block of questionBlocks) {
                block = block.trim();
                if (!block || block.startsWith('$CATEGORY:')) continue;
                
                const question = parseQuestion(block);
                if (question) {
                    questions.push(question);
                }
            }
            return questions;
        }

        function parseQuestion(block) {
            let title = '';
            let questionText = '';
            let answersBlock = '';
            
            const titleMatch = block.match(/^::([^:]+)::/);
            if (titleMatch) {
                title = titleMatch[1].trim();
                block = block.substring(titleMatch[0].length).trim();
            }
            
            let braceIndex = -1;
            let i = 0;
            while ((i = block.indexOf('{', i)) !== -1) {
                if (i > 0 && block[i - 1] === '\\') {
                    i++;
                    continue;
                }
                braceIndex = i;
                break;
            }
    
            if (braceIndex === -1) {
                return null; 
            }
    
            let depth = 0;
            let closingBraceIndex = -1;
            for (let j = braceIndex; j < block.length; j++) {
                const char = block[j];
                if (j > 0 && block[j - 1] === '\\') {
                    continue;
                }
                if (char === '{') {
                    depth++;
                } else if (char === '}') {
                    depth--;
                    if (depth === 0) {
                        closingBraceIndex = j;
                        break;
                    }
                }
            }
    
            if (closingBraceIndex === -1) {
                return null; 
            }
            
            questionText = block.substring(0, braceIndex).trim();
            answersBlock = block.substring(braceIndex + 1, closingBraceIndex).trim();
            
            if (!title) {
                title = questionText.length > 50 ? questionText.substring(0, 50) + '...' : questionText;
            }
            
            const question = {
                title: title,
                text: questionText,
                type: '',
                answers: []
            };
            
            if (answersBlock === 'T' || answersBlock === 'TRUE' || answersBlock === 'F' || answersBlock === 'FALSE') {
                question.type = 'trueFalse';
                question.correctAnswer = answersBlock === 'T' || answersBlock === 'TRUE';
                return question;
            }
            
            if (answersBlock === '' || answersBlock === ' ') {
                question.type = 'essay';
                return question;
            }
            
            if (answersBlock.startsWith('#')) {
                question.type = 'numerical';
                question.answers = parseNumericalAnswers(answersBlock);
                return question;
            }
            
            if (answersBlock.includes('->')) {
                question.type = 'matching';
                question.pairs = parseMatchingPairs(answersBlock);
                return question;
            }
            
            const lines = answersBlock.split(/\n/).filter(l => l.trim());
            const hasOnlyCorrect = lines.every(line => {
                const trimmed = line.trim();
                return trimmed.startsWith('=') || trimmed === '';
            });
            
            if (hasOnlyCorrect && lines.length > 0) {
                question.type = 'shortAnswer';
                question.answers = parseShortAnswers(answersBlock);
                return question;
            }
            
            question.type = 'multipleChoice';
            question.answers = parseMultipleChoiceAnswers(answersBlock);
            
            const correctCount = question.answers.filter(a => a.weight === 100).length;
            if (correctCount > 1) {
                question.type = 'multipleResponse';
            }
            
            return question;
        }

        function parseMultipleChoiceAnswers(answersBlock) {
            const answers = [];
            const lines = answersBlock.split(/(?=[~=])/);
            
            for (let line of lines) {
                line = line.trim();
                if (!line) continue;
                
                let weight = 0;
                let correct = false;
                let text = '';
                let feedback = '';
                
                const weightMatch = line.match(/^([~=])%(-?\d+)%/);
                if (weightMatch) {
                    weight = parseInt(weightMatch[2]);
                    correct = weight > 0;
                    line = line.substring(weightMatch[0].length);
                } else if (line.startsWith('=')) {
                    correct = true;
                    weight = 100;
                    line = line.substring(1);
                } else if (line.startsWith('~')) {
                    correct = false;
                    weight = 0;
                    line = line.substring(1);
                }
                
                const parts = line.split('#');
                text = parts[0].trim();
                if (parts.length > 1) {
                    feedback = parts.slice(1).join('#').trim();
                }
                
                if (text) {
                    answers.push({ text, correct, weight, feedback });
                }
            }
            
            return answers;
        }

        function parseShortAnswers(answersBlock) {
            const answers = [];
            const lines = answersBlock.split(/(?==)/);
            
            for (let line of lines) {
                line = line.trim();
                if (!line || !line.startsWith('=')) continue;
                
                line = line.substring(1);
                
                let text = '';
                let feedback = '';
                let weight = 100;
                
                const weightMatch = line.match(/^%(-?\d+)%/);
                if (weightMatch) {
                    weight = parseInt(weightMatch[1]);
                    line = line.substring(weightMatch[0].length);
                }
                
                const parts = line.split('#');
                text = parts[0].trim();
                if (parts.length > 1) {
                    feedback = parts.slice(1).join('#').trim();
                }
                
                if (text) {
                    answers.push({ text, weight, feedback });
                }
            }
            
            return answers;
        }

        function parseMatchingPairs(answersBlock) {
            const pairs = [];
            const lines = answersBlock.split(/\n/);
            
            for (let line of lines) {
                line = line.trim();
                if (!line || !line.includes('->')) continue;
                
                if (line.startsWith('=')) {
                    line = line.substring(1).trim();
                }
                
                const parts = line.split('->');
                if (parts.length === 2) {
                    pairs.push({
                        question: parts[0].trim(),
                        answer: parts[1].trim()
                    });
                }
            }
            
            return pairs;
        }

        function parseNumericalAnswers(answersBlock) {
            const answers = [];
            answersBlock = answersBlock.substring(1).trim();
            
            const lines = answersBlock.split(/(?=[=])/);
            
            for (let line of lines) {
                line = line.trim();
                if (!line) continue;
                
                let weight = 100;
                let value = 0;
                let margin = 0;
                let feedback = '';
                
                if (line.startsWith('=')) {
                    line = line.substring(1);
                    
                    if (line.match(/^%(-?\d+)%/)) {
                        const match = line.match(/^%(-?\d+)%/);
                        weight = parseInt(match[1]);
                        line = line.substring(match[0].length);
                    }
                    
                    const numMatch = line.match(/^(-?\d+\.?\d*)/);
                    if (numMatch) {
                        value = parseFloat(numMatch[1]);
                        line = line.substring(numMatch[0].length);
                        
                        if (line.startsWith(':')) {
                            const marginMatch = line.substring(1).match(/^(-?\d+\.?\d*)/);
                            if (marginMatch) {
                                margin = parseFloat(marginMatch[1]);
                                line = line.substring(marginMatch[0].length + 1);
                            }
                        }
                        
                        if (line.startsWith('..')) {
                            const rangeMatch = line.substring(2).match(/^(-?\d+\.?\d*)/);
                            if (rangeMatch) {
                                const maxValue = parseFloat(rangeMatch[1]);
                                margin = (maxValue - value) / 2;
                                value = (value + maxValue) / 2;
                                line = line.substring(rangeMatch[0].length + 2);
                            }
                        }
                        
                        if (line.includes('#')) {
                            const parts = line.split('#');
                            feedback = parts.slice(1).join('#').trim();
                        }
                        
                        answers.push({ value, margin, weight, feedback });
                    }
                } else {
                    const numMatch = line.match(/^(-?\d+\.?\d*)/);
                    if (numMatch) {
                        value = parseFloat(numMatch[1]);
                        line = line.substring(numMatch[0].length);
                        
                        if (line.startsWith(':')) {
                            const marginMatch = line.substring(1).match(/^(-?\d+\.?\d*)/);
                            if (marginMatch) {
                                margin = parseFloat(marginMatch[1]);
                            }
                        }
                        
                        answers.push({ value, margin, weight: 100, feedback: '' });
                    }
                }
            }
            
            if (answers.length === 0) {
                const simpleMatch = answersBlock.match(/(-?\d+\.?\d*)/);
                if (simpleMatch) {
                    const value = parseFloat(simpleMatch[1]);
                    const colonIndex = answersBlock.indexOf(':');
                    let margin = 0;
                    
                    if (colonIndex > -1) {
                        const marginMatch = answersBlock.substring(colonIndex + 1).match(/(-?\d+\.?\d*)/);
                        if (marginMatch) {
                            margin = parseFloat(marginMatch[1]);
                        }
                    }
                    
                    answers.push({ value, margin, weight: 100, feedback: '' });
                }
            }
            
            return answers;
        }

        function displayQuestions(questions) {
            const output = document.getElementById('output');
            const t = translations[currentLanguage];
            
            const summary = {};
            questions.forEach(q => {
                summary[q.type] = (summary[q.type] || 0) + 1;
            });
            
            let html = `<div class="info-box">${t.questionsFound} ${questions.length} ${t.questions}</div>`;
            
            html += `
                <div class="summary-box">
                    <div class="summary-title">
                        ${t.summaryTitle}
                    </div>
                    <div class="summary-grid">
            `;
            
            for (const [type, count] of Object.entries(summary)) {
                html += `
                    <div class="summary-item">
                        <div class="summary-count">${count}</div>
                        <div class="summary-label">${t.types[type] || type}</div>
                    </div>
                `;
            }
            
            html += `
                    </div>
                </div>
            `;
            
            html += '<div class="questions-container">';
            
            questions.forEach((question, index) => {
                html += `
                    <div class="question-card">
                        <div class="question-header">
                            <div class="question-number">${t.questionNumber} ${index + 1}</div>
                            <div class="question-title">${escapeHtml(question.title)}</div>
                            <span class="question-type-badge">${t.typeLabels[question.type]}</span>
                        </div>
                        <div class="question-body">
                            <div class="question-text">${escapeHtml(question.text)}</div>
                            ${renderAnswers(question)}
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            output.innerHTML = html;
        }

        function renderAnswers(question) {
            switch (question.type) {
                case 'multipleChoice':
                case 'multipleResponse':
                    return renderMultipleChoice(question);
                case 'trueFalse':
                    return renderTrueFalse(question);
                case 'shortAnswer':
                    return renderShortAnswer(question);
                case 'matching':
                    return renderMatching(question);
                case 'numerical':
                    return renderNumerical(question);
                case 'essay':
                    return renderEssay(question);
                default:
                    return '<p>Tipo de pregunta no soportado</p>';
            }
        }

        function renderMultipleChoice(question) {
            const isMultiple = question.type === 'multipleResponse';
            let html = '<ul class="answers-list">';
            
            question.answers.forEach((answer, index) => {
                let className = '';
                let icon = '';
                
                if (answer.weight === 100) {
                    className = 'correct';
                    icon = '‚úì';
                } else if (answer.weight > 0) {
                    className = 'partial';
                    icon = '‚óê';
                } else {
                    className = 'incorrect';
                    icon = '‚úó';
                }
                
                html += `
                    <li class="answer-item ${className}">
                        <div class="answer-marker ${isMultiple ? 'checkbox' : ''}">${icon}</div>
                        <div class="answer-content">
                            <div class="answer-text">
                                ${escapeHtml(answer.text)}
                                ${answer.weight !== 0 && answer.weight !== 100 ? `<span class="answer-weight">${answer.weight}%</span>` : ''}
                            </div>
                            ${answer.feedback ? `<div class="answer-feedback">üí¨ ${escapeHtml(answer.feedback)}</div>` : ''}
                        </div>
                    </li>
                `;
            });
            
            html += '</ul>';
            return html;
        }

        function renderTrueFalse(question) {
            const t = translations[currentLanguage];
            let html = '<ul class="answers-list">';
            
            const answers = [
                { text: t.true, isCorrect: true },
                { text: t.false, isCorrect: false }
            ];

            answers.forEach(answer => {
                const correct = (answer.isCorrect === question.correctAnswer);
                const className = correct ? 'correct' : 'incorrect';
                const icon = correct ? '‚úì' : '‚úó';
                
                html += `
                    <li class="answer-item ${className}">
                        <div class="answer-marker">${icon}</div>
                        <div class="answer-content">
                            <div class="answer-text">${answer.text}</div>
                        </div>
                    </li>
                `;
            });
            
            html += '</ul>';
            return html;
        }

        function renderShortAnswer(question) {
            const t = translations[currentLanguage];
            let html = `<div class="input-box">${t.shortAnswerExpected}</div>`;
            html += `<div style="margin-top: 15px;"><strong>${t.acceptedAnswers}</strong></div>`;
            html += '<ul class="answers-list">';
            
            question.answers.forEach(answer => {
                const className = answer.weight === 100 ? 'correct' : 'partial';
                
                html += `
                    <li class="answer-item ${className}">
                        <div class="answer-marker">‚úì</div>
                        <div class="answer-content">
                            <div class="answer-text">
                                ${escapeHtml(answer.text)}
                                ${answer.weight !== 100 ? `<span class="answer-weight">${answer.weight}%</span>` : ''}
                            </div>
                            ${answer.feedback ? `<div class="answer-feedback">üí¨ ${escapeHtml(answer.feedback)}</div>` : ''}
                        </div>
                    </li>
                `;
            });
            
            html += '</ul>';
            return html;
        }

        function renderMatching(question) {
            let html = '<div>';
            
            question.pairs.forEach(pair => {
                html += `
                    <div class="matching-pair">
                        <div class="matching-question">${escapeHtml(pair.question)}</div>
                        <div class="matching-arrow">‚Üí</div>
                        <div class="matching-answer">${escapeHtml(pair.answer)}</div>
                    </div>
                `;
            });
            
            html += '</div>';
            return html;
        }

        function renderNumerical(question) {
            const t = translations[currentLanguage];
            let html = '<div>';
            
            question.answers.forEach(answer => {
                html += `
                    <div class="numerical-answer" style="background: ${answer.weight === 100 ? '#d4edda' : '#fff3cd'}; border-color: ${answer.weight === 100 ? '#28a745' : '#ffc107'}; margin-bottom: 10px;">
                        <div class="numerical-value">
                            ${answer.value}${answer.margin > 0 ? ` ¬± ${answer.margin}` : ''}
                            ${answer.weight !== 100 ? `<span class="answer-weight">${answer.weight}%</span>` : ''}
                        </div>
                        ${answer.margin > 0 ? `<div class="numerical-details">${t.acceptedRange} ${answer.value - answer.margin} a ${answer.value + answer.margin}</div>` : ''}
                        ${answer.feedback ? `<div class="answer-feedback">üí¨ ${escapeHtml(answer.feedback)}</div>` : ''}
                    </div>
                `;
            });
            
            html += '</div>';
            return html;
        }

        function renderEssay(question) {
            const t = translations[currentLanguage];
            return `
                <div class="essay-placeholder">
                    <p>üìù ${t.essayText}</p>
                    <p style="margin-top: 10px; font-size: 0.9em;">${t.essayManual}</p>
                </div>
            `;
        }

        function escapeHtml(text) {
            if (typeof text !== 'string') return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function loadExample() {
            const examples = {
                es: `// Ejemplo con m√∫ltiples idiomas (mlang)
::Pregunta Moodle con Mlang::\\{mlang es\\}¬øCu√°l es la capital de Espa√±a?\\{mlang\\}\\{mlang en\\}What is the capital of Spain?\\{mlang\\}\\{mlang ca\\}Quina √©s la capital d'Espanya?\\{mlang\\} {
=\\{mlang es\\}Madrid\\{mlang\\}\\{mlang en\\}Madrid\\{mlang\\}\\{mlang ca\\}Madrid\\{mlang\\}#\\{mlang es\\}¬°Correcto!\\{mlang\\}\\{mlang en\\}Correct!\\{mlang\\}\\{mlang ca\\}Correcte!\\{mlang\\}
~\\{mlang es\\}Barcelona\\{mlang\\}\\{mlang en\\}Barcelona\\{mlang\\}\\{mlang ca\\}Barcelona\\{mlang\\}
~\\{mlang es\\}Lisboa\\{mlang\\}\\{mlang en\\}Lisbon\\{mlang\\}\\{mlang ca\\}Lisboa\\{mlang\\}
}

// Ejemplo completo de preguntas GIFT

::Opci√≥n M√∫ltiple Simple::¬øCu√°l es la capital de Francia?{
=Par√≠s #¬°Correcto! Par√≠s es la capital de Francia.
~Londres #Incorrecto. Londres es la capital del Reino Unido.
~Madrid #Incorrecto. Madrid es la capital de Espa√±a.
~Berl√≠n #Incorrecto. Berl√≠n es la capital de Alemania.
}

::Verdadero o Falso::La Tierra es plana.{F}

::Respuesta M√∫ltiple::¬øCu√°les de los siguientes son lenguajes de programaci√≥n? {
~%50%Python #Correcto, Python es un lenguaje de programaci√≥n.
~%50%JavaScript #Correcto, JavaScript es un lenguaje de programaci√≥n.
~HTML #Incorrecto, HTML es un lenguaje de marcado, no de programaci√≥n.
~CSS #Incorrecto, CSS es un lenguaje de estilos, no de programaci√≥n.
}

::Respuesta Corta::¬øQui√©n escribi√≥ Don Quijote de la Mancha?{
=Miguel de Cervantes
=Cervantes
=Miguel Cervantes
}

::Emparejamiento::Relaciona cada pa√≠s con su capital.{
=Espa√±a -> Madrid
=Francia -> Par√≠s
=Italia -> Roma
=Alemania -> Berl√≠n
}

::Pregunta Num√©rica::¬øCu√°l es el valor de pi con dos decimales? {#3.14:0.01}

::Pregunta Num√©rica con Cr√©dito Parcial::¬øEn qu√© a√±o se descubri√≥ Am√©rica?{#
=1492:0 #¬°Exacto! Crist√≥bal Col√≥n lleg√≥ a Am√©rica en 1492.
=%50%1490:2 #Casi correcto. Fue en 1492, tienes 50% de cr√©dito por estar cerca.
}

::Pregunta de Ensayo::Explica la importancia de la Revoluci√≥n Francesa en la historia europea.{}

::Palabra Perdida::Isaac Newton es famoso por formular la ley de la {=gravitaci√≥n =gravedad =gravitaci√≥n universal}.`,
                en: `// Example with multiple languages (mlang)
::Moodle Mlang Question::\\{mlang es\\}¬øCu√°l es la capital de Espa√±a?\\{mlang\\}\\{mlang en\\}What is the capital of Spain?\\{mlang\\}\\{mlang ca\\}Quina √©s la capital d'Espanya?\\{mlang\\} {
=\\{mlang es\\}Madrid\\{mlang\\}\\{mlang en\\}Madrid\\{mlang\\}\\{mlang ca\\}Madrid\\{mlang\\}#\\{mlang es\\}¬°Correcto!\\{mlang\\}\\{mlang en\\}Correct!\\{mlang\\}\\{mlang ca\\}Correcte!\\{mlang\\}
~\\{mlang es\\}Barcelona\\{mlang\\}\\{mlang en\\}Barcelona\\{mlang\\}\\{mlang ca\\}Barcelona\\{mlang\\}
~\\{mlang es\\}Lisboa\\{mlang\\}\\{mlang en\\}Lisbon\\{mlang\\}\\{mlang ca\\}Lisboa\\{mlang\\}
}

// Complete GIFT questions example

::Simple Multiple Choice::What is the capital of France?{
=Paris #Correct! Paris is the capital of France.
~London #Incorrect. London is the capital of the UK.
~Madrid #Incorrect. Madrid is the capital of Spain.
~Berlin #Incorrect. Berlin is the capital of Germany.
}

::True or False::The Earth is flat.{F}

::Multiple Response::Which of the following are programming languages? {
~%50%Python #Correct, Python is a programming language.
~%50%JavaScript #Correct, JavaScript is a programming language.
~HTML #Incorrect, HTML is a markup language, not a programming language.
~CSS #Incorrect, CSS is a styling language, not a programming language.
}

::Short Answer::Who wrote Don Quixote?{
=Miguel de Cervantes
=Cervantes
=de Cervantes
}

::Matching::Match each country with its capital.{
=Spain -> Madrid
=France -> Paris
=Italy -> Rome
=Germany -> Berlin
}

::Numerical Question::What is the value of pi to two decimal places? {#3.14:0.01}

::Numerical Question with Partial Credit::In what year was America discovered?{#
=1492:0 #Exactly! Columbus reached America in 1492.
=%50%1490:2 #Close. It was 1492, you get 50% credit for being close.
}

::Essay Question::Explain the importance of the French Revolution in European history.{}

::Missing Word::Isaac Newton is famous for formulating the law of {=gravitation =gravity =universal gravitation}.`
            };

            const example = examples[currentLanguage] || examples['es'];
            document.getElementById('giftInput').value = example;
            parseGIFT();
        }

        function clearAll() {
            document.getElementById('giftInput').value = '';
            document.getElementById('output').innerHTML = '';
            detectedContentLanguages.clear();
            updateContentLanguageSelector();
            document.getElementById('detectedLanguagesInfo').innerHTML = '';
        }

        window.addEventListener('load', () => {
            detectBrowserLanguage();
            
            const input = document.getElementById('giftInput').value;
            if (input.trim()) {
                parseGIFT();
            }
        });
    </script>
</body>
</html>


