<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualizador GIFT de Moodle (con soporte mlang y edici√≥n)</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f4f4f4;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: linear-gradient(135deg, #f7931e 0%, #ff6900 100%);
            color: white;
            padding: 30px;
            border-radius: 8px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            position: relative;
        }

        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.95;
            font-size: 1.1em;
        }

        .language-selector {
            position: absolute;
            top: 15px;
            right: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .language-selector label {
            color: white;
            font-weight: 600;
            font-size: 0.9em;
        }

        .language-selector select {
            padding: 8px 12px;
            border: 2px solid white;
            border-radius: 4px;
            background: white;
            color: #333;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .language-selector select:hover {
            background: #f8f9fa;
        }

        .language-selector select:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(255,255,255,0.3);
        }

        .input-section {
            background: white;
            padding: 25px;
            border-radius: 8px;
            margin-bottom: 30px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .input-section h2 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.4em;
        }

        textarea {
            width: 100%;
            min-height: 200px;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            resize: vertical;
            transition: border-color 0.3s;
        }

        textarea:focus {
            outline: none;
            border-color: #f7931e;
        }

        .button-group {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        button {
            background: #f7931e;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: background 0.3s;
        }

        button:hover {
            background: #e07d0e;
        }

        button.secondary {
            background: #6c757d;
        }

        button.secondary:hover {
            background: #5a6268;
        }

        button.small {
            padding: 6px 12px;
            font-size: 13px;
        }

        button.success {
            background: #28a745;
        }

        button.success:hover {
            background: #218838;
        }

        button.info {
            background: #17a2b8;
        }

        button.info:hover {
            background: #138496;
        }

        .summary-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 25px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .summary-title {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .summary-item {
            background: rgba(255,255,255,0.2);
            padding: 15px;
            border-radius: 6px;
            backdrop-filter: blur(10px);
        }

        .summary-count {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .summary-label {
            font-size: 0.9em;
            opacity: 0.95;
        }

        .questions-container {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .question-card {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 5px solid #f7931e;
        }

        .question-card.edited {
            border-left: 5px solid #28a745;
        }

        .question-header {
            background: #f8f9fa;
            padding: 15px 20px;
            border-bottom: 2px solid #e9ecef;
            position: relative;
        }

        .question-number {
            color: #f7931e;
            font-weight: bold;
            font-size: 0.9em;
            text-transform: uppercase;
        }

        .question-title {
            color: #333;
            font-weight: 600;
            font-size: 1.1em;
            margin-top: 5px;
        }

        .question-type-badge {
            display: inline-block;
            background: #f7931e;
            color: white;
            padding: 4px 10px;
            border-radius: 3px;
            font-size: 0.75em;
            font-weight: 600;
            margin-top: 8px;
            text-transform: uppercase;
        }

        .question-controls {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .question-lang-selector {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .question-lang-selector select {
            padding: 6px 10px;
            border-radius: 4px;
            border: 1px solid #ccc;
            font-size: 13px;
        }

        .edited-langs-indicator {
            display: inline-flex;
            gap: 5px;
            flex-wrap: wrap;
            margin-top: 8px;
        }

        .lang-badge {
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .lang-badge.edited {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .lang-badge.not-edited {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .question-body {
            padding: 20px;
        }

        .question-text {
            color: #333;
            font-size: 1.05em;
            margin-bottom: 20px;
            line-height: 1.7;
            position: relative;
        }

        .editable-section {
            position: relative;
            padding: 10px;
            border: 2px dashed transparent;
            border-radius: 4px;
            transition: all 0.3s;
        }

        .editable-section:hover {
            background: #f8f9fa;
            border-color: #f7931e;
        }

        .edit-button {
            position: absolute;
            top: 5px;
            right: 5px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .editable-section:hover .edit-button {
            opacity: 1;
        }

        .edit-mode {
            background: #fff3cd;
            border: 2px solid #ffc107;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 10px;
        }

        .edit-mode textarea {
            width: 100%;
            min-height: 80px;
            margin-bottom: 10px;
        }

        .edit-mode-buttons {
            display: flex;
            gap: 8px;
        }

        .answers-list {
            list-style: none;
        }

        .answer-item {
            background: #f8f9fa;
            padding: 12px 15px;
            margin-bottom: 10px;
            border-radius: 4px;
            border: 2px solid #e9ecef;
            display: flex;
            align-items: start;
            transition: all 0.3s;
            position: relative;
        }

        .answer-item:hover {
            background: #e9ecef;
        }

        .answer-marker {
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 24px;
            height: 24px;
            border: 2px solid #6c757d;
            border-radius: 50%;
            margin-right: 12px;
            font-size: 12px;
            font-weight: bold;
            flex-shrink: 0;
        }

        .answer-marker.checkbox {
            border-radius: 3px;
        }

        .answer-item.correct {
            background: #d4edda;
            border-color: #28a745;
        }

        .answer-item.correct .answer-marker {
            background: #28a745;
            border-color: #28a745;
            color: white;
        }

        .answer-item.incorrect {
            background: #f8d7da;
            border-color: #dc3545;
        }

        .answer-item.incorrect .answer-marker {
            background: #dc3545;
            border-color: #dc3545;
            color: white;
        }

        .answer-item.partial {
            background: #fff3cd;
            border-color: #ffc107;
        }

        .answer-item.partial .answer-marker {
            background: #ffc107;
            border-color: #ffc107;
            color: white;
        }

        .answer-content {
            flex: 1;
        }

        .answer-text {
            color: #333;
            font-size: 1em;
        }

        .answer-feedback {
            margin-top: 8px;
            padding: 8px 12px;
            background: rgba(255,255,255,0.7);
            border-radius: 4px;
            font-size: 0.9em;
            color: #555;
            font-style: italic;
        }

        .answer-weight {
            display: inline-block;
            background: #6c757d;
            color: white;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 0.8em;
            margin-left: 8px;
            font-weight: 600;
        }

        .matching-pair {
            display: flex;
            align-items: center;
            gap: 15px;
            background: #f8f9fa;
            padding: 12px 15px;
            margin-bottom: 10px;
            border-radius: 4px;
            border: 2px solid #28a745;
        }

        .matching-question {
            flex: 1;
            font-weight: 600;
            color: #333;
        }

        .matching-arrow {
            color: #28a745;
            font-weight: bold;
            font-size: 1.2em;
        }

        .matching-answer {
            flex: 1;
            color: #555;
        }

        .numerical-answer {
            background: #d4edda;
            padding: 15px;
            border-radius: 4px;
            border: 2px solid #28a745;
        }

        .numerical-value {
            font-size: 1.2em;
            font-weight: bold;
            color: #28a745;
            margin-bottom: 8px;
        }

        .numerical-details {
            color: #555;
            font-size: 0.9em;
        }

        .essay-placeholder {
            background: #f8f9fa;
            padding: 20px;
            border: 2px dashed #6c757d;
            border-radius: 4px;
            text-align: center;
            color: #6c757d;
            font-style: italic;
        }

        .input-box {
            background: #f8f9fa;
            padding: 12px;
            border: 2px solid #6c757d;
            border-radius: 4px;
            min-height: 40px;
            color: #6c757d;
            font-style: italic;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 4px;
            border-left: 5px solid #dc3545;
            margin-bottom: 20px;
        }

        .info-box {
            background: #d1ecf1;
            color: #0c5460;
            padding: 15px;
            border-radius: 4px;
            border-left: 5px solid #17a2b8;
            margin-bottom: 20px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }

        .empty-state svg {
            width: 100px;
            height: 100px;
            opacity: 0.3;
            margin-bottom: 20px;
        }

        .export-section {
            background: white;
            padding: 25px;
            border-radius: 8px;
            margin-bottom: 30px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: none;
        }

        .export-section.visible {
            display: block;
        }

        .gift-code-preview {
            background: #f8f9fa;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            margin-bottom: 15px;
        }

        footer {
            margin-top: 60px;
            padding: 25px;
            background: linear-gradient(135deg, #333 0%, #555 100%);
            color: white;
            text-align: center;
            border-radius: 8px;
            box-shadow: 0 -4px 6px rgba(0,0,0,0.1);
        }

        footer p {
            margin: 8px 0;
            font-size: 0.95em;
        }

        footer a {
            color: #f7931e;
            text-decoration: none;
            font-weight: 600;
            transition: color 0.3s;
        }

        footer a:hover {
            color: #ff6900;
            text-decoration: underline;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.5em;
                padding-right: 0;
            }
            
            .question-card {
                border-left-width: 3px;
            }

            .matching-pair {
                flex-direction: column;
                align-items: start;
            }

            .matching-arrow {
                transform: rotate(90deg);
            }

            .language-selector {
                position: static;
                margin-top: 15px;
                justify-content: center;
            }

            .summary-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="language-selector">
                <label for="languageSelect" id="langLabel">üåê Idioma:</label>
                <select id="languageSelect" onchange="changeLanguage()">
                    <option value="es">Espa√±ol</option>
                    <option value="ca">Catal√†</option>
                    <option value="eu">Euskara</option>
                    <option value="gl">Galego</option>
                    <option value="en">English</option>
                    <option value="fr">Fran√ßais</option>
                    <option value="de">Deutsch</option>
                </select>
            </div>
            <h1 id="mainTitle">üìö Visualizador GIFT de Moodle (con soporte mlang y edici√≥n)</h1>
            <p id="mainSubtitle">Visualiza y edita tus preguntas en formato GIFT, incluyendo contenido multiling√ºe (mlang).</p>
        </div>

        <div class="input-section">
            <h2 id="inputTitle">Ingresa tu c√≥digo GIFT</h2>
            <textarea id="giftInput" placeholder=""></textarea>
            <div class="button-group">
                <button onclick="parseGIFT()" id="parseBtn">üîç Visualizar Preguntas</button>
                <button class="secondary" onclick="loadExample()" id="exampleBtn">üìù Cargar Ejemplo</button>
                <button class="secondary" onclick="clearAll()" id="clearBtn">üóëÔ∏è Limpiar</button>
            </div>
            <div id="contentLanguageSelectorContainer" style="display: none; margin-top: 20px; background: #eef2f5; padding: 15px; border-radius: 6px; border: 1px solid #ddd;">
                <p id="detectedLanguagesInfo" style="font-size: 0.9em; color: #555; margin-bottom: 10px;"></p>
                <label id="contentLangLabel" for="contentLanguageSelect" style="font-weight: 600; color: #333; margin-right: 10px;">üåç Ver pregunta en el idioma:</label>
                <select id="contentLanguageSelect" onchange="handleContentLanguageChange()" style="padding: 8px 12px; border-radius: 4px; border: 1px solid #ccc; font-size: 14px;"></select>
            </div>
        </div>

        <div id="exportSection" class="export-section">
            <h2 id="exportTitle">üì§ Exportar C√≥digo GIFT Editado</h2>
            <div class="gift-code-preview" id="giftCodePreview"></div>
            <div class="button-group">
                <button class="success" onclick="copyGiftCode()" id="copyBtn">üìã Copiar C√≥digo</button>
                <button class="info" onclick="downloadGiftFile()" id="downloadBtn">üíæ Descargar Archivo</button>
            </div>
        </div>

        <div id="output"></div>

        <footer>
            <p id="footerCreated">Creado por <strong>Jos√© Luis Miralles Bono</strong></p>
            <p><a href="https://www.jlmirall.es" target="_blank" rel="noopener noreferrer">www.jlmirall.es</a></p>
        </footer>
    </div>

    <script>
        // Traducciones
        const translations = {
            es: {
                mainTitle: 'üìö Visualizador GIFT de Moodle (con soporte mlang y edici√≥n)',
                mainSubtitle: 'Visualiza y edita tus preguntas en formato GIFT, incluyendo contenido multiling√ºe (mlang).',
                inputTitle: 'Ingresa tu c√≥digo GIFT',
                parseBtn: 'üîç Visualizar Preguntas',
                exampleBtn: 'üìù Cargar Ejemplo',
                clearBtn: 'üóëÔ∏è Limpiar',
                langLabel: 'üåê Idioma:',
                contentLangLabel: 'üåç Ver pregunta en el idioma:',
                detectedLangsLabel: 'Idiomas detectados:',
                footerCreated: 'Creado por',
                emptyTitle: 'No hay preguntas para mostrar',
                emptyText: 'Ingresa c√≥digo GIFT en el √°rea de texto superior',
                noQuestionsFound: 'No se encontraron preguntas v√°lidas en el c√≥digo GIFT proporcionado.',
                errorParsing: 'Error al procesar el c√≥digo GIFT:',
                questionsFound: 'Se encontraron',
                questions: 'pregunta(s)',
                summaryTitle: 'üìä Resumen de Preguntas',
                questionNumber: 'Pregunta',
                viewInLang: 'Ver en:',
                resetToGeneral: 'üîÑ Idioma general',
                editedLanguages: 'Idiomas editados:',
                notEditedLanguages: 'No editados:',
                edit: '‚úèÔ∏è Editar',
                save: 'üíæ Guardar',
                cancel: '‚ùå Cancelar',
                delete: 'üóëÔ∏è Borrar',
                addAnswer: '‚ûï A√±adir respuesta',
                exportTitle: 'üì§ Exportar C√≥digo GIFT Editado',
                copyBtn: 'üìã Copiar C√≥digo',
                downloadBtn: 'üíæ Descargar Archivo',
                copiedSuccess: '‚úÖ C√≥digo copiado al portapapeles',
                types: {
                    multipleChoice: 'Opci√≥n m√∫ltiple',
                    multipleResponse: 'Respuesta m√∫ltiple',
                    trueFalse: 'Verdadero/Falso',
                    shortAnswer: 'Respuesta corta',
                    matching: 'Emparejamiento',
                    numerical: 'Num√©rica',
                    essay: 'Ensayo'
                },
                typeLabels: {
                    multipleChoice: 'Opci√≥n m√∫ltiple',
                    multipleResponse: 'Respuesta m√∫ltiple',
                    trueFalse: 'Verdadero/Falso',
                    shortAnswer: 'Respuesta corta',
                    matching: 'Emparejamiento',
                    numerical: 'Num√©rica',
                    essay: 'Ensayo'
                },
                true: 'Verdadero',
                false: 'Falso',
                shortAnswerExpected: 'Respuesta de texto corto esperada',
                acceptedAnswers: 'Respuestas correctas aceptadas:',
                essayText: 'El estudiante debe escribir una respuesta tipo ensayo',
                essayManual: 'Esta pregunta requiere evaluaci√≥n manual',
                acceptedRange: 'Rango aceptado:',
                placeholder: 'Pega aqu√≠ tu c√≥digo GIFT...\n\nEjemplo:\n::Pregunta 1::¬øCu√°l es la capital de Francia?{\n=Par√≠s #¬°Correcto!\n~Londres #Incorrecto, esa es la capital de Inglaterra\n~Madrid #Incorrecto, esa es la capital de Espa√±a\n}\n\n::Pregunta 2::La tierra es plana.{F}'
            },
            ca: {
                mainTitle: 'üìö Visualitzador GIFT de Moodle (amb suport mlang i edici√≥)',
                mainSubtitle: 'Visualitza i edita les teves preguntes en format GIFT, incloent-hi contingut multiling√ºe (mlang).',
                inputTitle: 'Introdueix el teu codi GIFT',
                parseBtn: 'üîç Visualitzar Preguntes',
                exampleBtn: 'üìù Carregar Exemple',
                clearBtn: 'üóëÔ∏è Netejar',
                langLabel: 'üåê Idioma:',
                contentLangLabel: 'üåç Veure pregunta en l\'idioma:',
                detectedLangsLabel: 'Idiomes detectats:',
                footerCreated: 'Creat per',
                emptyTitle: 'No hi ha preguntes per mostrar',
                emptyText: 'Introdueix codi GIFT a l\'√†rea de text superior',
                noQuestionsFound: 'No s\'han trobat preguntes v√†lides al codi GIFT proporcionat.',
                errorParsing: 'Error en processar el codi GIFT:',
                questionsFound: 'S\'han trobat',
                questions: 'pregunta/es',
                summaryTitle: 'üìä Resum de Preguntes',
                questionNumber: 'Pregunta',
                viewInLang: 'Veure en:',
                resetToGeneral: 'üîÑ Idioma general',
                editedLanguages: 'Idiomes editats:',
                notEditedLanguages: 'No editats:',
                edit: '‚úèÔ∏è Editar',
                save: 'üíæ Guardar',
                cancel: '‚ùå Cancel¬∑lar',
                delete: 'üóëÔ∏è Esborrar',
                addAnswer: '‚ûï Afegir resposta',
                exportTitle: 'üì§ Exportar Codi GIFT Editat',
                copyBtn: 'üìã Copiar Codi',
                downloadBtn: 'üíæ Descarregar Fitxer',
                copiedSuccess: '‚úÖ Codi copiat al portapapers',
                types: {
                    multipleChoice: 'Opci√≥ m√∫ltiple',
                    multipleResponse: 'Resposta m√∫ltiple',
                    trueFalse: 'Vertader/Fals',
                    shortAnswer: 'Resposta curta',
                    matching: 'Emparellament',
                    numerical: 'Num√®rica',
                    essay: 'Assaig'
                },
                typeLabels: {
                    multipleChoice: 'Opci√≥ m√∫ltiple',
                    multipleResponse: 'Resposta m√∫ltiple',
                    trueFalse: 'Vertader/Fals',
                    shortAnswer: 'Resposta curta',
                    matching: 'Emparellament',
                    numerical: 'Num√®rica',
                    essay: 'Assaig'
                },
                true: 'Vertader',
                false: 'Fals',
                shortAnswerExpected: 'Resposta de text curt esperada',
                acceptedAnswers: 'Respostes correctes acceptades:',
                essayText: 'L\'estudiant ha d\'escriure una resposta tipus assaig',
                essayManual: 'Aquesta pregunta requereix avaluaci√≥ manual',
                acceptedRange: 'Rang acceptat:',
                placeholder: 'Enganxa aqu√≠ el teu codi GIFT...'
            },
            en: {
                mainTitle: 'üìö Moodle GIFT Viewer (mlang supported + editing)',
                mainSubtitle: 'Visualize and edit your GIFT format questions, including multilingual content (mlang).',
                inputTitle: 'Enter your GIFT code',
                parseBtn: 'üîç Visualize Questions',
                exampleBtn: 'üìù Load Example',
                clearBtn: 'üóëÔ∏è Clear',
                langLabel: 'üåê Language:',
                contentLangLabel: 'üåç View question in language:',
                detectedLangsLabel: 'Detected languages:',
                footerCreated: 'Created by',
                emptyTitle: 'No questions to display',
                emptyText: 'Enter GIFT code in the text area above',
                noQuestionsFound: 'No valid questions found in the provided GIFT code.',
                errorParsing: 'Error processing GIFT code:',
                questionsFound: 'Found',
                questions: 'question(s)',
                summaryTitle: 'üìä Questions Summary',
                questionNumber: 'Question',
                viewInLang: 'View in:',
                resetToGeneral: 'üîÑ General language',
                editedLanguages: 'Edited languages:',
                notEditedLanguages: 'Not edited:',
                edit: '‚úèÔ∏è Edit',
                save: 'üíæ Save',
                cancel: '‚ùå Cancel',
                delete: 'üóëÔ∏è Delete',
                addAnswer: '‚ûï Add answer',
                exportTitle: 'üì§ Export Edited GIFT Code',
                copyBtn: 'üìã Copy Code',
                downloadBtn: 'üíæ Download File',
                copiedSuccess: '‚úÖ Code copied to clipboard',
                types: {
                    multipleChoice: 'Multiple choice',
                    multipleResponse: 'Multiple response',
                    trueFalse: 'True/False',
                    shortAnswer: 'Short answer',
                    matching: 'Matching',
                    numerical: 'Numerical',
                    essay: 'Essay'
                },
                typeLabels: {
                    multipleChoice: 'Multiple choice',
                    multipleResponse: 'Multiple response',
                    trueFalse: 'True/False',
                    shortAnswer: 'Short answer',
                    matching: 'Matching',
                    numerical: 'Numerical',
                    essay: 'Essay'
                },
                true: 'True',
                false: 'False',
                shortAnswerExpected: 'Short text answer expected',
                acceptedAnswers: 'Accepted correct answers:',
                essayText: 'Student must write an essay-type answer',
                essayManual: 'This question requires manual evaluation',
                acceptedRange: 'Accepted range:',
                placeholder: 'Paste your GIFT code here...'
            }
        };

        let currentLanguage = 'es';
        let originalParsedQuestions = [];
        let detectedContentLanguages = new Set();
        let selectedContentLanguage = null;
        let questionLanguageOverrides = {}; // Para almacenar idioma por pregunta
        let editedQuestions = {}; // Para rastrear cambios por pregunta y idioma

        function detectBrowserLanguage() {
            const browserLang = navigator.language || navigator.userLanguage;
            const langCode = browserLang.split('-')[0];
            
            if (translations[langCode]) {
                currentLanguage = langCode;
            } else {
                currentLanguage = 'es'; 
            }
            
            document.getElementById('languageSelect').value = currentLanguage;
            updateUILanguage();
        }

        function changeLanguage() {
            currentLanguage = document.getElementById('languageSelect').value;
            updateUILanguage();
            if (originalParsedQuestions.length > 0) {
                filterAndDisplayQuestions();
            }
        }

        function updateUILanguage() {
            const t = translations[currentLanguage];
            
            document.getElementById('mainTitle').textContent = t.mainTitle;
            document.getElementById('mainSubtitle').textContent = t.mainSubtitle;
            document.getElementById('inputTitle').textContent = t.inputTitle;
            document.getElementById('parseBtn').textContent = t.parseBtn;
            document.getElementById('exampleBtn').textContent = t.exampleBtn;
            document.getElementById('clearBtn').textContent = t.clearBtn;
            document.getElementById('langLabel').textContent = t.langLabel;
            document.getElementById('giftInput').placeholder = t.placeholder;
            document.getElementById('contentLangLabel').textContent = t.contentLangLabel;
            document.getElementById('exportTitle').textContent = t.exportTitle;
            document.getElementById('copyBtn').textContent = t.copyBtn;
            document.getElementById('downloadBtn').textContent = t.downloadBtn;
            
            const footerText = document.getElementById('footerCreated');
            footerText.innerHTML = `${t.footerCreated} <strong>Jos√© Luis Miralles Bono</strong>`;

            const infoEl = document.getElementById('detectedLanguagesInfo');
            if (detectedContentLanguages.size > 0) {
                const languages = Array.from(detectedContentLanguages).sort();
                infoEl.innerHTML = `<strong>${t.detectedLangsLabel}</strong> ${languages.join(', ')}`;
            }
        }
        
        function handleContentLanguageChange() {
            selectedContentLanguage = document.getElementById('contentLanguageSelect').value;
            filterAndDisplayQuestions();
        }

        function setQuestionLanguage(questionIndex, lang) {
            questionLanguageOverrides[questionIndex] = lang;
            filterAndDisplayQuestions();
        }

        function resetQuestionLanguage(questionIndex) {
            delete questionLanguageOverrides[questionIndex];
            filterAndDisplayQuestions();
        }

        function processMlangText(text, targetLang) {
            if (!text || typeof text !== 'string' || !targetLang) {
                return text;
            }

            const fullBlockRegex = /(?:\\\{mlang [a-zA-Z_\-]+\s*\\\}.*?\\\{mlang\\\})+/gs;

            return text.replace(fullBlockRegex, (fullBlock) => {
                const langSpecificRegex = /\\\{mlang ([a-zA-Z_\-]+)\s*\\\}(.*?)\\\{mlang\\\}/gs;
                const langs = {};
                let match;
                while ((match = langSpecificRegex.exec(fullBlock)) !== null) {
                    langs[match[1]] = match[2];
                }

                if (langs[targetLang]) {
                    return langs[targetLang];
                }
                const firstLang = Object.keys(langs)[0];
                return firstLang ? langs[firstLang] : ''; 
            });
        }

        function filterAndDisplayQuestions() {
            if (!originalParsedQuestions || originalParsedQuestions.length === 0) {
                document.getElementById('output').innerHTML = '';
                return;
            }

            const filteredQuestions = JSON.parse(JSON.stringify(originalParsedQuestions));

            filteredQuestions.forEach((question, idx) => {
                const questionLang = questionLanguageOverrides[idx] || selectedContentLanguage;
                
                if (!questionLang || detectedContentLanguages.size === 0) {
                    return;
                }

                question.title = processMlangText(question.title, questionLang);
                question.text = processMlangText(question.text, questionLang);

                if (question.answers) {
                    question.answers.forEach(answer => {
                        answer.text = processMlangText(answer.text, questionLang);
                        if (answer.feedback) {
                            answer.feedback = processMlangText(answer.feedback, questionLang);
                        }
                    });
                }
                if (question.pairs) {
                    question.pairs.forEach(pair => {
                        pair.question = processMlangText(pair.question, questionLang);
                        pair.answer = processMlangText(pair.answer, questionLang);
                    });
                }
            });

            displayQuestions(filteredQuestions);
        }

        function updateContentLanguageSelector() {
            const container = document.getElementById('contentLanguageSelectorContainer');
            const select = document.getElementById('contentLanguageSelect');
            const infoEl = document.getElementById('detectedLanguagesInfo');

            if (detectedContentLanguages.size > 0) {
                select.innerHTML = '';
                const languages = Array.from(detectedContentLanguages).sort();
                
                infoEl.innerHTML = `<strong>${translations[currentLanguage].detectedLangsLabel}</strong> ${languages.join(', ')}`;

                languages.forEach(lang => {
                    const option = document.createElement('option');
                    option.value = lang;
                    option.textContent = lang.toUpperCase();
                    select.appendChild(option);
                });
                
                selectedContentLanguage = languages[0];
                select.value = selectedContentLanguage;

                container.style.display = 'block';
            } else {
                selectedContentLanguage = null;
                infoEl.innerHTML = '';
                container.style.display = 'none';
            }
        }

        function startEdit(questionIndex, section, subIndex = null) {
            const editId = `edit-${questionIndex}-${section}${subIndex !== null ? '-' + subIndex : ''}`;
            const contentId = `content-${questionIndex}-${section}${subIndex !== null ? '-' + subIndex : ''}`;
            
            const contentEl = document.getElementById(contentId);
            const editEl = document.getElementById(editId);
            
            if (!contentEl || !editEl) return;
            
            contentEl.style.display = 'none';
            editEl.style.display = 'block';
            
            const textarea = editEl.querySelector('textarea');
            if (textarea) {
                textarea.focus();
            }
        }

        function cancelEdit(questionIndex, section, subIndex = null) {
            const editId = `edit-${questionIndex}-${section}${subIndex !== null ? '-' + subIndex : ''}`;
            const contentId = `content-${questionIndex}-${section}${subIndex !== null ? '-' + subIndex : ''}`;
            
            const contentEl = document.getElementById(contentId);
            const editEl = document.getElementById(editId);
            
            if (!contentEl || !editEl) return;
            
            contentEl.style.display = 'block';
            editEl.style.display = 'none';
        }

        function deleteShortAnswer(questionIndex, answerIndex) {
            const t = translations[currentLanguage];
            if (!confirm(`¬øEst√°s seguro de que quieres borrar esta respuesta?`)) {
                return;
            }

            originalParsedQuestions[questionIndex].answers.splice(answerIndex, 1);

            const currentLang = questionLanguageOverrides[questionIndex] || selectedContentLanguage || 'default';
            if (!editedQuestions[questionIndex]) {
                editedQuestions[questionIndex] = {
                    langs: new Set(),
                    edits: {}
                };
            }
            editedQuestions[questionIndex].langs.add(currentLang);

            filterAndDisplayQuestions();
            updateExportSection();
        }

        function addShortAnswer(questionIndex) {
            const currentLang = questionLanguageOverrides[questionIndex] || selectedContentLanguage || 'default';

            const newAnswer = {
                text: currentLang !== 'default' ? `\\{mlang ${currentLang}\\}Nueva respuesta\\{mlang\\}` : 'Nueva respuesta',
                weight: 100,
                feedback: ''
            };

            originalParsedQuestions[questionIndex].answers.push(newAnswer);

            if (!editedQuestions[questionIndex]) {
                editedQuestions[questionIndex] = {
                    langs: new Set(),
                    edits: {}
                };
            }
            editedQuestions[questionIndex].langs.add(currentLang);

            filterAndDisplayQuestions();
            updateExportSection();
        }

        function saveNumericalEdit(questionIndex, answerIndex) {
            const valueInput = document.getElementById(`numerical-value-${questionIndex}-${answerIndex}`);
            const marginInput = document.getElementById(`numerical-margin-${questionIndex}-${answerIndex}`);
            const weightInput = document.getElementById(`numerical-weight-${questionIndex}-${answerIndex}`);

            const newValue = parseFloat(valueInput.value) || 0;
            const newMargin = parseFloat(marginInput.value) || 0;
            const newWeight = parseInt(weightInput.value) || 100;

            originalParsedQuestions[questionIndex].answers[answerIndex].value = newValue;
            originalParsedQuestions[questionIndex].answers[answerIndex].margin = newMargin;
            originalParsedQuestions[questionIndex].answers[answerIndex].weight = newWeight;

            const currentLang = questionLanguageOverrides[questionIndex] || selectedContentLanguage || 'default';
            if (!editedQuestions[questionIndex]) {
                editedQuestions[questionIndex] = {
                    langs: new Set(),
                    edits: {}
                };
            }
            editedQuestions[questionIndex].langs.add(currentLang);

            cancelEdit(questionIndex, 'numerical', answerIndex);
            filterAndDisplayQuestions();
            updateExportSection();
        }

        function saveMultipleChoiceEdit(questionIndex, answerIndex) {
            const textArea = document.getElementById(`answer-text-${questionIndex}-${answerIndex}`);
            const weightInput = document.getElementById(`answer-weight-${questionIndex}-${answerIndex}`);

            const newText = textArea.value;
            const newWeight = parseInt(weightInput.value) || 0;

            const currentLang = questionLanguageOverrides[questionIndex] || selectedContentLanguage || 'default';

            // Actualizar texto
            originalParsedQuestions[questionIndex].answers[answerIndex].text = updateMlangText(
                originalParsedQuestions[questionIndex].answers[answerIndex].text,
                currentLang,
                newText
            );

            // Actualizar peso y propiedad correct
            originalParsedQuestions[questionIndex].answers[answerIndex].weight = newWeight;
            originalParsedQuestions[questionIndex].answers[answerIndex].correct = newWeight > 0;

            // Marcar como editado
            if (!editedQuestions[questionIndex]) {
                editedQuestions[questionIndex] = {
                    langs: new Set(),
                    edits: {}
                };
            }
            editedQuestions[questionIndex].langs.add(currentLang);

            if (!editedQuestions[questionIndex].edits[currentLang]) {
                editedQuestions[questionIndex].edits[currentLang] = {};
            }
            if (!editedQuestions[questionIndex].edits[currentLang].answers) {
                editedQuestions[questionIndex].edits[currentLang].answers = {};
            }
            editedQuestions[questionIndex].edits[currentLang].answers[answerIndex] = newText;

            cancelEdit(questionIndex, 'answer', answerIndex);
            filterAndDisplayQuestions();
            updateExportSection();
        }

        function toggleTrueFalseAnswer(questionIndex) {
            originalParsedQuestions[questionIndex].correctAnswer = !originalParsedQuestions[questionIndex].correctAnswer;

            const currentLang = questionLanguageOverrides[questionIndex] || selectedContentLanguage || 'default';
            if (!editedQuestions[questionIndex]) {
                editedQuestions[questionIndex] = {
                    langs: new Set(),
                    edits: {}
                };
            }
            editedQuestions[questionIndex].langs.add(currentLang);

            filterAndDisplayQuestions();
            updateExportSection();
        }

        function saveEdit(questionIndex, section, subIndex = null) {
            const editId = `edit-${questionIndex}-${section}${subIndex !== null ? '-' + subIndex : ''}`;
            const editEl = document.getElementById(editId);
            const textarea = editEl.querySelector('textarea');
            const newValue = textarea.value;
            
            const currentLang = questionLanguageOverrides[questionIndex] || selectedContentLanguage || 'default';
            
            if (!editedQuestions[questionIndex]) {
                editedQuestions[questionIndex] = {
                    langs: new Set(),
                    edits: {}
                };
            }
            
            editedQuestions[questionIndex].langs.add(currentLang);
            
            if (!editedQuestions[questionIndex].edits[currentLang]) {
                editedQuestions[questionIndex].edits[currentLang] = {};
            }
            
            if (section === 'title') {
                originalParsedQuestions[questionIndex].title = updateMlangText(
                    originalParsedQuestions[questionIndex].title,
                    currentLang,
                    newValue
                );
                editedQuestions[questionIndex].edits[currentLang].title = newValue;
            } else if (section === 'text') {
                originalParsedQuestions[questionIndex].text = updateMlangText(
                    originalParsedQuestions[questionIndex].text,
                    currentLang,
                    newValue
                );
                editedQuestions[questionIndex].edits[currentLang].text = newValue;
            } else if (section === 'answer' && subIndex !== null) {
                originalParsedQuestions[questionIndex].answers[subIndex].text = updateMlangText(
                    originalParsedQuestions[questionIndex].answers[subIndex].text,
                    currentLang,
                    newValue
                );
                if (!editedQuestions[questionIndex].edits[currentLang].answers) {
                    editedQuestions[questionIndex].edits[currentLang].answers = {};
                }
                editedQuestions[questionIndex].edits[currentLang].answers[subIndex] = newValue;
            } else if (section === 'feedback' && subIndex !== null) {
                originalParsedQuestions[questionIndex].answers[subIndex].feedback = updateMlangText(
                    originalParsedQuestions[questionIndex].answers[subIndex].feedback || '',
                    currentLang,
                    newValue
                );
                if (!editedQuestions[questionIndex].edits[currentLang].feedbacks) {
                    editedQuestions[questionIndex].edits[currentLang].feedbacks = {};
                }
                editedQuestions[questionIndex].edits[currentLang].feedbacks[subIndex] = newValue;
            } else if (section === 'pair-question' && subIndex !== null) {
                originalParsedQuestions[questionIndex].pairs[subIndex].question = updateMlangText(
                    originalParsedQuestions[questionIndex].pairs[subIndex].question,
                    currentLang,
                    newValue
                );
                if (!editedQuestions[questionIndex].edits[currentLang].pairs) {
                    editedQuestions[questionIndex].edits[currentLang].pairs = {};
                }
                if (!editedQuestions[questionIndex].edits[currentLang].pairs[subIndex]) {
                    editedQuestions[questionIndex].edits[currentLang].pairs[subIndex] = {};
                }
                editedQuestions[questionIndex].edits[currentLang].pairs[subIndex].question = newValue;
            } else if (section === 'pair-answer' && subIndex !== null) {
                originalParsedQuestions[questionIndex].pairs[subIndex].answer = updateMlangText(
                    originalParsedQuestions[questionIndex].pairs[subIndex].answer,
                    currentLang,
                    newValue
                );
                if (!editedQuestions[questionIndex].edits[currentLang].pairs) {
                    editedQuestions[questionIndex].edits[currentLang].pairs = {};
                }
                if (!editedQuestions[questionIndex].edits[currentLang].pairs[subIndex]) {
                    editedQuestions[questionIndex].edits[currentLang].pairs[subIndex] = {};
                }
                editedQuestions[questionIndex].edits[currentLang].pairs[subIndex].answer = newValue;
            } else if (section === 'wrong-feedback') {
                originalParsedQuestions[questionIndex].wrongFeedback = updateMlangText(
                    originalParsedQuestions[questionIndex].wrongFeedback || '',
                    currentLang,
                    newValue
                );
            } else if (section === 'correct-feedback') {
                originalParsedQuestions[questionIndex].correctFeedback = updateMlangText(
                    originalParsedQuestions[questionIndex].correctFeedback || '',
                    currentLang,
                    newValue
                );
            }

            cancelEdit(questionIndex, section, subIndex);
            filterAndDisplayQuestions();
            updateExportSection();
        }

        function updateMlangText(originalText, targetLang, newText) {
            if (!originalText || typeof originalText !== 'string') {
                return `\\{mlang ${targetLang}\\}${newText}\\{mlang\\}`;
            }
            
            const fullBlockRegex = /(?:\\\{mlang [a-zA-Z_\-]+\s*\\\}.*?\\\{mlang\\\})+/gs;
            const hasMLang = fullBlockRegex.test(originalText);
            
            if (!hasMLang) {
                return `\\{mlang ${targetLang}\\}${newText}\\{mlang\\}`;
            }
            
            let updated = false;
            const result = originalText.replace(fullBlockRegex, (fullBlock) => {
                const langSpecificRegex = /\\\{mlang ([a-zA-Z_\-]+)\s*\\\}(.*?)\\\{mlang\\\}/gs;
                const langs = {};
                let match;
                while ((match = langSpecificRegex.exec(fullBlock)) !== null) {
                    langs[match[1]] = match[2];
                }
                
                langs[targetLang] = newText;
                updated = true;
                
                let rebuilt = '';
                for (const [lang, text] of Object.entries(langs)) {
                    rebuilt += `\\{mlang ${lang}\\}${text}\\{mlang\\}`;
                }
                return rebuilt;
            });
            
            if (!updated) {
                return originalText + `\\{mlang ${targetLang}\\}${newText}\\{mlang\\}`;
            }
            
            return result;
        }

        function generateGIFTCode() {
            let giftCode = '';
            
            originalParsedQuestions.forEach((question, idx) => {
                giftCode += `::${question.title}::${question.text}`;
                
                if (question.type === 'trueFalse') {
                    giftCode += `{${question.correctAnswer ? 'T' : 'F'}}`;
                } else if (question.type === 'essay') {
                    giftCode += `{}`;
                } else if (question.type === 'multipleChoice' || question.type === 'multipleResponse') {
                    giftCode += '{\n';
                    question.answers.forEach(answer => {
                        const prefix = answer.weight === 100 ? '=' : (answer.weight > 0 ? `~%${answer.weight}%` : '~');
                        giftCode += `${prefix}${answer.text}`;
                        if (answer.feedback) {
                            giftCode += `#${answer.feedback}`;
                        }
                        giftCode += '\n';
                    });
                    giftCode += '}';
                } else if (question.type === 'shortAnswer') {
                    giftCode += '{\n';
                    question.answers.forEach(answer => {
                        giftCode += `=${answer.text}`;
                        if (answer.feedback) {
                            giftCode += `#${answer.feedback}`;
                        }
                        giftCode += '\n';
                    });
                    giftCode += '}';
                } else if (question.type === 'matching') {
                    giftCode += '{\n';
                    question.pairs.forEach(pair => {
                        giftCode += `=${pair.question} -> ${pair.answer}\n`;
                    });
                    giftCode += '}';
                } else if (question.type === 'numerical') {
                    giftCode += '{#\n';
                    question.answers.forEach(answer => {
                        const weight = answer.weight !== 100 ? `%${answer.weight}%` : '';
                        giftCode += `=${weight}${answer.value}${answer.margin > 0 ? ':' + answer.margin : ''}`;
                        if (answer.feedback) {
                            giftCode += `#${answer.feedback}`;
                        }
                        giftCode += '\n';
                    });
                    giftCode += '}';
                }
                
                giftCode += '\n\n';
            });
            
            return giftCode;
        }

        function updateExportSection() {
            const hasEdits = Object.keys(editedQuestions).length > 0;
            const exportSection = document.getElementById('exportSection');
            
            if (hasEdits) {
                exportSection.classList.add('visible');
                const giftCode = generateGIFTCode();
                document.getElementById('giftCodePreview').textContent = giftCode;
            } else {
                exportSection.classList.remove('visible');
            }
        }

        function copyGiftCode() {
            const giftCode = document.getElementById('giftCodePreview').textContent;
            navigator.clipboard.writeText(giftCode).then(() => {
                const btn = document.getElementById('copyBtn');
                const originalText = btn.textContent;
                btn.textContent = translations[currentLanguage].copiedSuccess;
                setTimeout(() => {
                    btn.textContent = originalText;
                }, 2000);
            });
        }

        function downloadGiftFile() {
            const giftCode = document.getElementById('giftCodePreview').textContent;
            const blob = new Blob([giftCode], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'preguntas_editadas.gift';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function parseGIFT() {
            const input = document.getElementById('giftInput').value;
            const output = document.getElementById('output');
            const t = translations[currentLanguage];
            
            originalParsedQuestions = [];
            detectedContentLanguages.clear();
            selectedContentLanguage = null;
            questionLanguageOverrides = {};
            editedQuestions = {};
            document.getElementById('exportSection').classList.remove('visible');

            if (!input.trim()) {
                output.innerHTML = `
                    <div class="empty-state">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        <h3>${t.emptyTitle}</h3>
                        <p>${t.emptyText}</p>
                    </div>
                `;
                updateContentLanguageSelector(); 
                return;
            }

            const langRegex = /\\\{mlang ([a-zA-Z_\-]+)\s*\\\}/g;
            let match;
            while ((match = langRegex.exec(input)) !== null) {
                detectedContentLanguages.add(match[1]);
            }
            
            updateContentLanguageSelector();

            try {
                originalParsedQuestions = parseGIFTFormat(input);
                
                if (originalParsedQuestions.length === 0) {
                    output.innerHTML = `<div class="error-message">${t.noQuestionsFound}</div>`;
                    document.getElementById('contentLanguageSelectorContainer').style.display = 'none';
                    return;
                }

                filterAndDisplayQuestions();

            } catch (error) {
                output.innerHTML = `<div class="error-message">${t.errorParsing} ${error.message}</div>`;
                document.getElementById('contentLanguageSelectorContainer').style.display = 'none';
            }
        }

        function parseGIFTFormat(text) {
            text = text.replace(/^\/\/.*$/gm, '');
            const questionBlocks = text.split(/\n\s*\n/).filter(block => block.trim());
            const questions = [];
            
            for (let block of questionBlocks) {
                block = block.trim();
                if (!block || block.startsWith('$CATEGORY:')) continue;
                
                const question = parseQuestion(block);
                if (question) {
                    questions.push(question);
                }
            }
            return questions;
        }

        function parseQuestion(block) {
            let title = '';
            let questionText = '';
            let answersBlock = '';
            
            const titleMatch = block.match(/^::([^:]+)::/);
            if (titleMatch) {
                title = titleMatch[1].trim();
                block = block.substring(titleMatch[0].length).trim();
            }
            
            let braceIndex = -1;
            let i = 0;
            while ((i = block.indexOf('{', i)) !== -1) {
                if (i > 0 && block[i - 1] === '\\') {
                    i++;
                    continue;
                }
                braceIndex = i;
                break;
            }
    
            if (braceIndex === -1) {
                return null; 
            }
    
            let depth = 0;
            let closingBraceIndex = -1;
            for (let j = braceIndex; j < block.length; j++) {
                const char = block[j];
                if (j > 0 && block[j - 1] === '\\') {
                    continue;
                }
                if (char === '{') {
                    depth++;
                } else if (char === '}') {
                    depth--;
                    if (depth === 0) {
                        closingBraceIndex = j;
                        break;
                    }
                }
            }
    
            if (closingBraceIndex === -1) {
                return null; 
            }
            
            questionText = block.substring(0, braceIndex).trim();
            answersBlock = block.substring(braceIndex + 1, closingBraceIndex).trim();
            
            if (!title) {
                title = questionText.length > 50 ? questionText.substring(0, 50) + '...' : questionText;
            }
            
            const question = {
                title: title,
                text: questionText,
                type: '',
                answers: []
            };
            
            // Check for True/False questions
            const tfMatch = answersBlock.match(/^(T|TRUE|F|FALSE)\s*(#([^#]*)(#(.*))?)?$/i);
            if (tfMatch) {
                question.type = 'trueFalse';
                const answer = tfMatch[1].toUpperCase();
                question.correctAnswer = answer === 'T' || answer === 'TRUE';

                // Parse feedback
                if (tfMatch[3]) {
                    question.wrongFeedback = tfMatch[3].trim();
                    if (tfMatch[5]) {
                        question.correctFeedback = tfMatch[5].trim();
                    }
                }

                return question;
            }
            
            if (answersBlock === '' || answersBlock === ' ') {
                question.type = 'essay';
                return question;
            }
            
            if (answersBlock.startsWith('#')) {
                question.type = 'numerical';
                question.answers = parseNumericalAnswers(answersBlock);
                return question;
            }
            
            if (answersBlock.includes('->')) {
                question.type = 'matching';
                question.pairs = parseMatchingPairs(answersBlock);
                return question;
            }
            
            const lines = answersBlock.split(/\n/).filter(l => l.trim());
            const hasOnlyCorrect = lines.every(line => {
                const trimmed = line.trim();
                return trimmed.startsWith('=') || trimmed === '';
            });
            
            if (hasOnlyCorrect && lines.length > 0) {
                question.type = 'shortAnswer';
                question.answers = parseShortAnswers(answersBlock);
                return question;
            }
            
            question.type = 'multipleChoice';
            question.answers = parseMultipleChoiceAnswers(answersBlock);
            
            const correctCount = question.answers.filter(a => a.weight === 100).length;
            if (correctCount > 1) {
                question.type = 'multipleResponse';
            }
            
            return question;
        }

        function parseMultipleChoiceAnswers(answersBlock) {
            const answers = [];
            const lines = answersBlock.split(/(?=[~=])/);
            
            for (let line of lines) {
                line = line.trim();
                if (!line) continue;
                
                let weight = 0;
                let correct = false;
                let text = '';
                let feedback = '';
                
                const weightMatch = line.match(/^([~=])%(-?\d+)%/);
                if (weightMatch) {
                    weight = parseInt(weightMatch[2]);
                    correct = weight > 0;
                    line = line.substring(weightMatch[0].length);
                } else if (line.startsWith('=')) {
                    correct = true;
                    weight = 100;
                    line = line.substring(1);
                } else if (line.startsWith('~')) {
                    correct = false;
                    weight = 0;
                    line = line.substring(1);
                }
                
                const parts = line.split('#');
                text = parts[0].trim();
                if (parts.length > 1) {
                    feedback = parts.slice(1).join('#').trim();
                }
                
                if (text) {
                    answers.push({ text, correct, weight, feedback });
                }
            }
            
            return answers;
        }

        function parseShortAnswers(answersBlock) {
            const answers = [];
            const lines = answersBlock.split(/(?==)/);
            
            for (let line of lines) {
                line = line.trim();
                if (!line || !line.startsWith('=')) continue;
                
                line = line.substring(1);
                
                let text = '';
                let feedback = '';
                let weight = 100;
                
                const weightMatch = line.match(/^%(-?\d+)%/);
                if (weightMatch) {
                    weight = parseInt(weightMatch[1]);
                    line = line.substring(weightMatch[0].length);
                }
                
                const parts = line.split('#');
                text = parts[0].trim();
                if (parts.length > 1) {
                    feedback = parts.slice(1).join('#').trim();
                }
                
                if (text) {
                    answers.push({ text, weight, feedback });
                }
            }
            
            return answers;
        }

        function parseMatchingPairs(answersBlock) {
            const pairs = [];
            const lines = answersBlock.split(/\n/);
            
            for (let line of lines) {
                line = line.trim();
                if (!line || !line.includes('->')) continue;
                
                if (line.startsWith('=')) {
                    line = line.substring(1).trim();
                }
                
                const parts = line.split('->');
                if (parts.length === 2) {
                    pairs.push({
                        question: parts[0].trim(),
                        answer: parts[1].trim()
                    });
                }
            }
            
            return pairs;
        }

        function parseNumericalAnswers(answersBlock) {
            const answers = [];
            answersBlock = answersBlock.substring(1).trim();

            // Split by newlines and filter empty lines
            const lines = answersBlock.split(/\n/).filter(l => l.trim());

            // Si solo hay una l√≠nea, es formato simple
            if (lines.length === 1) {
                const answer = parseNumericalLine(lines[0], 100);
                if (answer) answers.push(answer);
            } else {
                // M√∫ltiples respuestas con pesos
                for (let line of lines) {
                    line = line.trim();
                    if (!line || !line.startsWith('=')) continue;

                    line = line.substring(1); // Quitar el =

                    let weight = 100;
                    // Extraer peso si existe
                    if (line.match(/^%(-?\d+)%/)) {
                        const match = line.match(/^%(-?\d+)%/);
                        weight = parseInt(match[1]);
                        line = line.substring(match[0].length);
                    }

                    const answer = parseNumericalLine(line, weight);
                    if (answer) answers.push(answer);
                }
            }

            return answers;
        }

        function parseNumericalLine(line, weight) {
            line = line.trim();
            let value = 0;
            let margin = 0;

            // Formato de rango: MinValue..MaxValue
            const rangeMatch = line.match(/^(-?\d+\.?\d*)\.\.(-?\d+\.?\d*)/);
            if (rangeMatch) {
                const minValue = parseFloat(rangeMatch[1]);
                const maxValue = parseFloat(rangeMatch[2]);
                value = (minValue + maxValue) / 2;
                margin = (maxValue - minValue) / 2;
                return { value, margin, weight };
            }

            // Formato con margen: Value:Margin
            const valueMarginMatch = line.match(/^(-?\d+\.?\d*):(-?\d+\.?\d*)/);
            if (valueMarginMatch) {
                value = parseFloat(valueMarginMatch[1]);
                margin = parseFloat(valueMarginMatch[2]);
                return { value, margin, weight };
            }

            // Formato simple: solo Value
            const simpleMatch = line.match(/^(-?\d+\.?\d*)/);
            if (simpleMatch) {
                value = parseFloat(simpleMatch[1]);
                margin = 0;
                return { value, margin, weight };
            }

            return null;
        }

        function displayQuestions(questions) {
            const output = document.getElementById('output');
            const t = translations[currentLanguage];
            
            const summary = {};
            questions.forEach(q => {
                summary[q.type] = (summary[q.type] || 0) + 1;
            });
            
            let html = `<div class="info-box">${t.questionsFound} ${questions.length} ${t.questions}</div>`;
            
            html += `
                <div class="summary-box">
                    <div class="summary-title">
                        ${t.summaryTitle}
                    </div>
                    <div class="summary-grid">
            `;
            
            for (const [type, count] of Object.entries(summary)) {
                html += `
                    <div class="summary-item">
                        <div class="summary-count">${count}</div>
                        <div class="summary-label">${t.types[type] || type}</div>
                    </div>
                `;
            }
            
            html += `
                    </div>
                </div>
            `;
            
            html += '<div class="questions-container">';
            
            questions.forEach((question, index) => {
                const isEdited = editedQuestions[index];
                const questionLang = questionLanguageOverrides[index] || selectedContentLanguage;
                
                html += `
                    <div class="question-card ${isEdited ? 'edited' : ''}">
                        <div class="question-header">
                            <div class="question-number">${t.questionNumber} ${index + 1}</div>
                            <div class="question-title">${escapeHtml(question.title)}</div>
                            <span class="question-type-badge">${t.typeLabels[question.type]}</span>
                `;
                
                // Controles de idioma y edici√≥n
                if (detectedContentLanguages.size > 0) {
                    html += `
                        <div class="question-controls">
                            <div class="question-lang-selector">
                                <label>${t.viewInLang}</label>
                                <select onchange="setQuestionLanguage(${index}, this.value)">
                    `;
                    
                    Array.from(detectedContentLanguages).sort().forEach(lang => {
                        const selected = lang === questionLang ? 'selected' : '';
                        html += `<option value="${lang}" ${selected}>${lang.toUpperCase()}</option>`;
                    });
                    
                    html += `
                                </select>
                            </div>
                            ${questionLanguageOverrides[index] ? `<button class="small secondary" onclick="resetQuestionLanguage(${index})">${t.resetToGeneral}</button>` : ''}
                        </div>
                    `;
                    
                    // Indicador de idiomas editados
                    if (isEdited) {
                        const editedLangs = Array.from(isEdited.langs);
                        const notEditedLangs = Array.from(detectedContentLanguages).filter(l => !editedLangs.includes(l));
                        
                        html += `<div class="edited-langs-indicator">`;
                        html += `<strong style="font-size: 0.85em; margin-right: 5px;">${t.editedLanguages}</strong>`;
                        editedLangs.forEach(lang => {
                            html += `<span class="lang-badge edited">${lang}</span>`;
                        });
                        if (notEditedLangs.length > 0) {
                            html += `<strong style="font-size: 0.85em; margin: 0 5px;">${t.notEditedLanguages}</strong>`;
                            notEditedLangs.forEach(lang => {
                                html += `<span class="lang-badge not-edited">${lang}</span>`;
                            });
                        }
                        html += `</div>`;
                    }
                }
                
                html += `
                        </div>
                        <div class="question-body">
                `;
                
                // T√≠tulo editable
                html += `
                    <div class="editable-section">
                        <div id="content-${index}-title">
                            <strong>T√≠tulo:</strong> ${escapeHtml(question.title)}
                        </div>
                        <div id="edit-${index}-title" class="edit-mode" style="display: none;">
                            <textarea>${escapeHtml(question.title)}</textarea>
                            <div class="edit-mode-buttons">
                                <button class="small success" onclick="saveEdit(${index}, 'title')">${t.save}</button>
                                <button class="small secondary" onclick="cancelEdit(${index}, 'title')">${t.cancel}</button>
                            </div>
                        </div>
                        <button class="small edit-button" onclick="startEdit(${index}, 'title')">${t.edit}</button>
                    </div>
                `;
                
                // Texto de pregunta editable
                html += `
                    <div class="editable-section">
                        <div id="content-${index}-text" class="question-text">${escapeHtml(question.text)}</div>
                        <div id="edit-${index}-text" class="edit-mode" style="display: none;">
                            <textarea>${escapeHtml(question.text)}</textarea>
                            <div class="edit-mode-buttons">
                                <button class="small success" onclick="saveEdit(${index}, 'text')">${t.save}</button>
                                <button class="small secondary" onclick="cancelEdit(${index}, 'text')">${t.cancel}</button>
                            </div>
                        </div>
                        <button class="small edit-button" onclick="startEdit(${index}, 'text')">${t.edit}</button>
                    </div>
                `;
                
                html += renderAnswers(question, index);
                
                html += `
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            output.innerHTML = html;
        }

        function renderAnswers(question, questionIndex) {
            switch (question.type) {
                case 'multipleChoice':
                case 'multipleResponse':
                    return renderMultipleChoice(question, questionIndex);
                case 'trueFalse':
                    return renderTrueFalse(question, questionIndex);
                case 'shortAnswer':
                    return renderShortAnswer(question, questionIndex);
                case 'matching':
                    return renderMatching(question, questionIndex);
                case 'numerical':
                    return renderNumerical(question, questionIndex);
                case 'essay':
                    return renderEssay(question);
                default:
                    return '<p>Tipo de pregunta no soportado</p>';
            }
        }

        function renderMultipleChoice(question, questionIndex) {
            const t = translations[currentLanguage];
            const isMultiple = question.type === 'multipleResponse';
            let html = '<ul class="answers-list">';
            
            question.answers.forEach((answer, answerIndex) => {
                let className = '';
                let icon = '';
                
                if (answer.weight === 100) {
                    className = 'correct';
                    icon = '‚úì';
                } else if (answer.weight > 0) {
                    className = 'partial';
                    icon = '‚óê';
                } else {
                    className = 'incorrect';
                    icon = '‚úó';
                }
                
                html += `
                    <li class="answer-item ${className}">
                        <div class="answer-marker ${isMultiple ? 'checkbox' : ''}">${icon}</div>
                        <div class="answer-content" style="width: 100%;">
                            <div class="editable-section">
                                <div id="content-${questionIndex}-answer-${answerIndex}" class="answer-text">
                                    ${escapeHtml(answer.text)}
                                    <span class="answer-weight">${answer.weight}%</span>
                                    <span class="answer-weight" style="background: ${answer.correct ? '#28a745' : '#dc3545'}; margin-left: 5px;">
                                        ${answer.correct ? '‚úì Correcta' : '‚úó Incorrecta'}
                                    </span>
                                </div>
                                <div id="edit-${questionIndex}-answer-${answerIndex}" class="edit-mode" style="display: none;">
                                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Texto de la respuesta:</label>
                                    <textarea id="answer-text-${questionIndex}-${answerIndex}">${escapeHtml(answer.text)}</textarea>
                                    <label style="display: block; margin-top: 10px; margin-bottom: 5px; font-weight: 600;">Peso (%):</label>
                                    <input type="number" min="-100" max="100" value="${answer.weight}" id="answer-weight-${questionIndex}-${answerIndex}" style="width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px;">
                                    <div style="font-size: 0.9em; color: #666; margin-bottom: 10px;">
                                        üí° 100 = Correcta completa, 0 = Incorrecta, valores intermedios = Cr√©dito parcial, negativos = Penalizaci√≥n
                                    </div>
                                    <div class="edit-mode-buttons">
                                        <button class="small success" onclick="saveMultipleChoiceEdit(${questionIndex}, ${answerIndex})">${t.save}</button>
                                        <button class="small secondary" onclick="cancelEdit(${questionIndex}, 'answer', ${answerIndex})">${t.cancel}</button>
                                    </div>
                                </div>
                                <button class="small edit-button" onclick="startEdit(${questionIndex}, 'answer', ${answerIndex})">${t.edit}</button>
                            </div>
                `;
                
                if (answer.feedback) {
                    html += `
                        <div class="editable-section">
                            <div id="content-${questionIndex}-feedback-${answerIndex}" class="answer-feedback">
                                üí¨ ${escapeHtml(answer.feedback)}
                            </div>
                            <div id="edit-${questionIndex}-feedback-${answerIndex}" class="edit-mode" style="display: none;">
                                <textarea>${escapeHtml(answer.feedback)}</textarea>
                                <div class="edit-mode-buttons">
                                    <button class="small success" onclick="saveEdit(${questionIndex}, 'feedback', ${answerIndex})">${t.save}</button>
                                    <button class="small secondary" onclick="cancelEdit(${questionIndex}, 'feedback', ${answerIndex})">${t.cancel}</button>
                                </div>
                            </div>
                            <button class="small edit-button" onclick="startEdit(${questionIndex}, 'feedback', ${answerIndex})">${t.edit}</button>
                        </div>
                    `;
                }
                
                html += `
                        </div>
                    </li>
                `;
            });
            
            html += '</ul>';
            return html;
        }

        function renderTrueFalse(question, questionIndex) {
            const t = translations[currentLanguage];
            let html = '<ul class="answers-list">';

            const answers = [
                { text: t.true, isCorrect: true },
                { text: t.false, isCorrect: false }
            ];

            answers.forEach(answer => {
                const correct = (answer.isCorrect === question.correctAnswer);
                const className = correct ? 'correct' : 'incorrect';
                const icon = correct ? '‚úì' : '‚úó';

                html += `
                    <li class="answer-item ${className}">
                        <div class="answer-marker">${icon}</div>
                        <div class="answer-content">
                            <div class="answer-text">${answer.text}</div>
                        </div>
                    </li>
                `;
            });

            html += '</ul>';

            // Bot√≥n para cambiar la respuesta correcta
            html += `
                <div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 4px;">
                    <strong>Respuesta correcta actual: ${question.correctAnswer ? t.true : t.false}</strong>
                    <button class="small secondary" onclick="toggleTrueFalseAnswer(${questionIndex})" style="margin-left: 10px; opacity: 1;">
                        üîÑ Cambiar a ${question.correctAnswer ? t.false : t.true}
                    </button>
                </div>
            `;

            // Mostrar y editar feedbacks
            if (question.wrongFeedback || question.correctFeedback) {
                html += '<div style="margin-top: 15px;">';
                const currentLang = questionLanguageOverrides[questionIndex] || selectedContentLanguage || 'default';

                if (question.wrongFeedback) {
                    const wrongFeedbackText = extractMlangText(question.wrongFeedback, currentLang);
                    html += `
                        <div class="editable-section" style="margin-bottom: 10px;">
                            <div id="content-${questionIndex}-wrong-feedback">
                                <strong>Feedback (respuesta incorrecta):</strong>
                                <div class="answer-feedback">üí¨ ${escapeHtml(wrongFeedbackText)}</div>
                            </div>
                            <div id="edit-${questionIndex}-wrong-feedback" class="edit-mode" style="display: none;">
                                <textarea>${escapeHtml(wrongFeedbackText)}</textarea>
                                <div class="edit-mode-buttons">
                                    <button class="small success" onclick="saveEdit(${questionIndex}, 'wrong-feedback')">${t.save}</button>
                                    <button class="small secondary" onclick="cancelEdit(${questionIndex}, 'wrong-feedback')">${t.cancel}</button>
                                </div>
                            </div>
                            <button class="small edit-button" onclick="startEdit(${questionIndex}, 'wrong-feedback')" style="opacity: 1;">${t.edit}</button>
                        </div>
                    `;
                }

                if (question.correctFeedback) {
                    const correctFeedbackText = extractMlangText(question.correctFeedback, currentLang);
                    html += `
                        <div class="editable-section">
                            <div id="content-${questionIndex}-correct-feedback">
                                <strong>Feedback (respuesta correcta):</strong>
                                <div class="answer-feedback">üí¨ ${escapeHtml(correctFeedbackText)}</div>
                            </div>
                            <div id="edit-${questionIndex}-correct-feedback" class="edit-mode" style="display: none;">
                                <textarea>${escapeHtml(correctFeedbackText)}</textarea>
                                <div class="edit-mode-buttons">
                                    <button class="small success" onclick="saveEdit(${questionIndex}, 'correct-feedback')">${t.save}</button>
                                    <button class="small secondary" onclick="cancelEdit(${questionIndex}, 'correct-feedback')">${t.cancel}</button>
                                </div>
                            </div>
                            <button class="small edit-button" onclick="startEdit(${questionIndex}, 'correct-feedback')" style="opacity: 1;">${t.edit}</button>
                        </div>
                    `;
                }

                html += '</div>';
            }

            return html;
        }

        function renderShortAnswer(question, questionIndex) {
            const t = translations[currentLanguage];
            let html = `<div class="input-box">${t.shortAnswerExpected}</div>`;
            html += `<div style="margin-top: 15px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;">`;
            html += `<strong>${t.acceptedAnswers}</strong>`;
            html += `<button class="small success" onclick="addShortAnswer(${questionIndex})" style="opacity: 1;">${t.addAnswer}</button>`;
            html += `</div>`;
            html += '<ul class="answers-list">';

            question.answers.forEach((answer, answerIndex) => {
                const className = answer.weight === 100 ? 'correct' : 'partial';

                html += `
                    <li class="answer-item ${className}" style="position: relative;">
                        <div class="answer-marker">‚úì</div>
                        <div class="answer-content" style="width: 100%;">
                            <div class="editable-section">
                                <div id="content-${questionIndex}-answer-${answerIndex}" class="answer-text">
                                    ${escapeHtml(answer.text)}
                                    ${answer.weight !== 100 ? `<span class="answer-weight">${answer.weight}%</span>` : ''}
                                </div>
                                <div id="edit-${questionIndex}-answer-${answerIndex}" class="edit-mode" style="display: none;">
                                    <textarea>${escapeHtml(answer.text)}</textarea>
                                    <div class="edit-mode-buttons">
                                        <button class="small success" onclick="saveEdit(${questionIndex}, 'answer', ${answerIndex})">${t.save}</button>
                                        <button class="small secondary" onclick="cancelEdit(${questionIndex}, 'answer', ${answerIndex})">${t.cancel}</button>
                                    </div>
                                </div>
                                <div style="display: flex; gap: 5px; position: absolute; top: 5px; right: 5px;">
                                    <button class="small edit-button" onclick="startEdit(${questionIndex}, 'answer', ${answerIndex})" style="opacity: 1; position: static;">${t.edit}</button>
                                    ${question.answers.length > 1 ? `<button class="small secondary" onclick="deleteShortAnswer(${questionIndex}, ${answerIndex})" style="opacity: 1; position: static; background: #dc3545;" onmouseover="this.style.background='#c82333'" onmouseout="this.style.background='#dc3545'">${t.delete}</button>` : ''}
                                </div>
                            </div>
                            ${answer.feedback ? `
                                <div class="editable-section">
                                    <div id="content-${questionIndex}-feedback-${answerIndex}" class="answer-feedback">
                                        üí¨ ${escapeHtml(answer.feedback)}
                                    </div>
                                    <div id="edit-${questionIndex}-feedback-${answerIndex}" class="edit-mode" style="display: none;">
                                        <textarea>${escapeHtml(answer.feedback)}</textarea>
                                        <div class="edit-mode-buttons">
                                            <button class="small success" onclick="saveEdit(${questionIndex}, 'feedback', ${answerIndex})">${t.save}</button>
                                            <button class="small secondary" onclick="cancelEdit(${questionIndex}, 'feedback', ${answerIndex})">${t.cancel}</button>
                                        </div>
                                    </div>
                                    <button class="small edit-button" onclick="startEdit(${questionIndex}, 'feedback', ${answerIndex})">${t.edit}</button>
                                </div>
                            ` : ''}
                        </div>
                    </li>
                `;
            });

            html += '</ul>';
            return html;
        }

        function renderMatching(question, questionIndex) {
            const t = translations[currentLanguage];
            let html = '<div>';

            question.pairs.forEach((pair, pairIndex) => {
                html += `
                    <div class="matching-pair">
                        <div class="matching-question" style="flex: 1;">
                            <div class="editable-section">
                                <div id="content-${questionIndex}-pair-question-${pairIndex}">
                                    ${escapeHtml(pair.question)}
                                </div>
                                <div id="edit-${questionIndex}-pair-question-${pairIndex}" class="edit-mode" style="display: none;">
                                    <textarea>${escapeHtml(pair.question)}</textarea>
                                    <div class="edit-mode-buttons">
                                        <button class="small success" onclick="saveEdit(${questionIndex}, 'pair-question', ${pairIndex})">${t.save}</button>
                                        <button class="small secondary" onclick="cancelEdit(${questionIndex}, 'pair-question', ${pairIndex})">${t.cancel}</button>
                                    </div>
                                </div>
                                <button class="small edit-button" onclick="startEdit(${questionIndex}, 'pair-question', ${pairIndex})">${t.edit}</button>
                            </div>
                        </div>
                        <div class="matching-arrow">‚Üí</div>
                        <div class="matching-answer" style="flex: 1;">
                            <div class="editable-section">
                                <div id="content-${questionIndex}-pair-answer-${pairIndex}">
                                    ${escapeHtml(pair.answer)}
                                </div>
                                <div id="edit-${questionIndex}-pair-answer-${pairIndex}" class="edit-mode" style="display: none;">
                                    <textarea>${escapeHtml(pair.answer)}</textarea>
                                    <div class="edit-mode-buttons">
                                        <button class="small success" onclick="saveEdit(${questionIndex}, 'pair-answer', ${pairIndex})">${t.save}</button>
                                        <button class="small secondary" onclick="cancelEdit(${questionIndex}, 'pair-answer', ${pairIndex})">${t.cancel}</button>
                                    </div>
                                </div>
                                <button class="small edit-button" onclick="startEdit(${questionIndex}, 'pair-answer', ${pairIndex})">${t.edit}</button>
                            </div>
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            return html;
        }

        function renderNumerical(question, questionIndex) {
            const t = translations[currentLanguage];
            let html = '<div>';

            question.answers.forEach((answer, answerIndex) => {
                html += `
                    <div class="numerical-answer" style="background: ${answer.weight === 100 ? '#d4edda' : '#fff3cd'}; border-color: ${answer.weight === 100 ? '#28a745' : '#ffc107'}; margin-bottom: 10px; position: relative;">
                        <div class="editable-section">
                            <div id="content-${questionIndex}-numerical-${answerIndex}">
                                <div class="numerical-value">
                                    ${answer.value}${answer.margin > 0 ? ` ¬± ${answer.margin}` : ''}
                                    ${answer.weight !== 100 ? `<span class="answer-weight">${answer.weight}%</span>` : ''}
                                </div>
                                ${answer.margin > 0 ? `<div class="numerical-details">${t.acceptedRange} ${answer.value - answer.margin} a ${answer.value + answer.margin}</div>` : ''}
                            </div>
                            <div id="edit-${questionIndex}-numerical-${answerIndex}" class="edit-mode" style="display: none;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 600;">Valor:</label>
                                <input type="number" step="any" value="${answer.value}" id="numerical-value-${questionIndex}-${answerIndex}" style="width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 600;">Margen de error:</label>
                                <input type="number" step="any" value="${answer.margin}" id="numerical-margin-${questionIndex}-${answerIndex}" style="width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 600;">Peso (%):</label>
                                <input type="number" min="0" max="100" value="${answer.weight}" id="numerical-weight-${questionIndex}-${answerIndex}" style="width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px;">
                                <div class="edit-mode-buttons">
                                    <button class="small success" onclick="saveNumericalEdit(${questionIndex}, ${answerIndex})">${t.save}</button>
                                    <button class="small secondary" onclick="cancelEdit(${questionIndex}, 'numerical', ${answerIndex})">${t.cancel}</button>
                                </div>
                            </div>
                            <button class="small edit-button" onclick="startEdit(${questionIndex}, 'numerical', ${answerIndex})" style="position: absolute; top: 5px; right: 5px; opacity: 1;">${t.edit}</button>
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            return html;
        }

        function renderEssay(question) {
            const t = translations[currentLanguage];
            return `
                <div class="essay-placeholder">
                    <p>üìù ${t.essayText}</p>
                    <p style="margin-top: 10px; font-size: 0.9em;">${t.essayManual}</p>
                </div>
            `;
        }

        function escapeHtml(text) {
            if (typeof text !== 'string') return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function loadExample() {
    const example = `// Ejemplos completos de preguntas GIFT con mlang (es/en/ca)

::Opci√≥n M√∫ltiple Simple::\\{mlang es\\}¬øCu√°l es la capital de Francia?\\{mlang\\}\\{mlang en\\}What is the capital of France?\\{mlang\\}\\{mlang ca\\}Quina √©s la capital de Fran√ßa?\\{mlang\\}{
=\\{mlang es\\}Par√≠s\\{mlang\\}\\{mlang en\\}Paris\\{mlang\\}\\{mlang ca\\}Par√≠s\\{mlang\\}#\\{mlang es\\}¬°Correcto! Par√≠s es la capital de Francia.\\{mlang\\}\\{mlang en\\}Correct! Paris is the capital of France.\\{mlang\\}\\{mlang ca\\}Correcte! Par√≠s √©s la capital de Fran√ßa.\\{mlang\\}
~\\{mlang es\\}Londres\\{mlang\\}\\{mlang en\\}London\\{mlang\\}\\{mlang ca\\}Londres\\{mlang\\}#\\{mlang es\\}Incorrecto. Londres es la capital del Reino Unido.\\{mlang\\}\\{mlang en\\}Incorrect. London is the capital of the UK.\\{mlang\\}\\{mlang ca\\}Incorrecte. Londres √©s la capital del Regne Unit.\\{mlang\\}
~\\{mlang es\\}Madrid\\{mlang\\}\\{mlang en\\}Madrid\\{mlang\\}\\{mlang ca\\}Madrid\\{mlang\\}#\\{mlang es\\}Incorrecto. Madrid es la capital de Espa√±a.\\{mlang\\}\\{mlang en\\}Incorrect. Madrid is the capital of Spain.\\{mlang\\}\\{mlang ca\\}Incorrecte. Madrid √©s la capital d'Espanya.\\{mlang\\}
~\\{mlang es\\}Berl√≠n\\{mlang\\}\\{mlang en\\}Berlin\\{mlang\\}\\{mlang ca\\}Berl√≠n\\{mlang\\}#\\{mlang es\\}Incorrecto. Berl√≠n es la capital de Alemania.\\{mlang\\}\\{mlang en\\}Incorrect. Berlin is the capital of Germany.\\{mlang\\}\\{mlang ca\\}Incorrecte. Berl√≠n √©s la capital d'Alemanya.\\{mlang\\}
}

::Verdadero o Falso con Feedback::\\{mlang es\\}La Tierra es plana.\\{mlang\\}\\{mlang en\\}The Earth is flat.\\{mlang\\}\\{mlang ca\\}La Terra √©s plana.\\{mlang\\}{F#\\{mlang es\\}Incorrecto. La Tierra es esf√©rica.\\{mlang\\}\\{mlang en\\}Incorrect. The Earth is spherical.\\{mlang\\}\\{mlang ca\\}Incorrecte. La Terra √©s esf√®rica.\\{mlang\\}#\\{mlang es\\}¬°Correcto! La Tierra NO es plana.\\{mlang\\}\\{mlang en\\}Correct! The Earth is NOT flat.\\{mlang\\}\\{mlang ca\\}Correcte! La Terra NO √©s plana.\\{mlang\\}}

::Verdadero o Falso Simple::\\{mlang es\\}42 es la respuesta absoluta a todo.\\{mlang\\}\\{mlang en\\}42 is the Absolute Answer to everything.\\{mlang\\}\\{mlang ca\\}42 √©s la resposta absoluta a tot.\\{mlang\\}{FALSE}

::Respuesta M√∫ltiple::\\{mlang es\\}¬øCu√°les de los siguientes son lenguajes de programaci√≥n?\\{mlang\\}\\{mlang en\\}Which of the following are programming languages?\\{mlang\\}\\{mlang ca\\}Quins dels seg√ºents s√≥n llenguatges de programaci√≥?\\{mlang\\}{
~%50%\\{mlang es\\}Python\\{mlang\\}\\{mlang en\\}Python\\{mlang\\}\\{mlang ca\\}Python\\{mlang\\}#\\{mlang es\\}Correcto. Python es un lenguaje de programaci√≥n.\\{mlang\\}\\{mlang en\\}Correct. Python is a programming language.\\{mlang\\}\\{mlang ca\\}Correcte. Python √©s un llenguatge de programaci√≥.\\{mlang\\}
~%50%\\{mlang es\\}JavaScript\\{mlang\\}\\{mlang en\\}JavaScript\\{mlang\\}\\{mlang ca\\}JavaScript\\{mlang\\}#\\{mlang es\\}Correcto. JavaScript es un lenguaje de programaci√≥n.\\{mlang\\}\\{mlang en\\}Correct. JavaScript is a programming language.\\{mlang\\}\\{mlang ca\\}Correcte. JavaScript √©s un llenguatge de programaci√≥.\\{mlang\\}
~\\{mlang es\\}HTML\\{mlang\\}\\{mlang en\\}HTML\\{mlang\\}\\{mlang ca\\}HTML\\{mlang\\}#\\{mlang es\\}Incorrecto. HTML es un lenguaje de marcado.\\{mlang\\}\\{mlang en\\}Incorrect. HTML is a markup language.\\{mlang\\}\\{mlang ca\\}Incorrecte. HTML √©s un llenguatge de marcat.\\{mlang\\}
~\\{mlang es\\}CSS\\{mlang\\}\\{mlang en\\}CSS\\{mlang\\}\\{mlang ca\\}CSS\\{mlang\\}#\\{mlang es\\}Incorrecto. CSS es un lenguaje de estilos.\\{mlang\\}\\{mlang en\\}Incorrect. CSS is a styling language.\\{mlang\\}\\{mlang ca\\}Incorrecte. CSS √©s un llenguatge d'estils.\\{mlang\\}
}

::Respuesta Corta::\\{mlang es\\}¬øQui√©n escribi√≥ Don Quijote de la Mancha?\\{mlang\\}\\{mlang en\\}Who wrote Don Quixote?\\{mlang\\}\\{mlang ca\\}Qui va escriure Don Quixot de la Manxa?\\{mlang\\}{
=\\{mlang es\\}Miguel de Cervantes\\{mlang\\}\\{mlang en\\}Miguel de Cervantes\\{mlang\\}\\{mlang ca\\}Miquel de Cervantes\\{mlang\\}
=\\{mlang es\\}Cervantes\\{mlang\\}\\{mlang en\\}Cervantes\\{mlang\\}\\{mlang ca\\}Cervantes\\{mlang\\}
=\\{mlang es\\}Miguel Cervantes\\{mlang\\}\\{mlang en\\}Miguel Cervantes\\{mlang\\}\\{mlang ca\\}Miquel Cervantes\\{mlang\\}
}

::Emparejamiento::\\{mlang es\\}Relaciona cada pa√≠s con su capital.\\{mlang\\}\\{mlang en\\}Match each country with its capital.\\{mlang\\}\\{mlang ca\\}Relaciona cada pa√≠s amb la seva capital.\\{mlang\\}{
=\\{mlang es\\}Espa√±a\\{mlang\\}\\{mlang en\\}Spain\\{mlang\\}\\{mlang ca\\}Espanya\\{mlang\\} -> \\{mlang es\\}Madrid\\{mlang\\}\\{mlang en\\}Madrid\\{mlang\\}\\{mlang ca\\}Madrid\\{mlang\\}
=\\{mlang es\\}Francia\\{mlang\\}\\{mlang en\\}France\\{mlang\\}\\{mlang ca\\}Fran√ßa\\{mlang\\} -> \\{mlang es\\}Par√≠s\\{mlang\\}\\{mlang en\\}Paris\\{mlang\\}\\{mlang ca\\}Par√≠s\\{mlang\\}
=\\{mlang es\\}Italia\\{mlang\\}\\{mlang en\\}Italy\\{mlang\\}\\{mlang ca\\}It√†lia\\{mlang\\} -> \\{mlang es\\}Roma\\{mlang\\}\\{mlang en\\}Rome\\{mlang\\}\\{mlang ca\\}Roma\\{mlang\\}
=\\{mlang es\\}Alemania\\{mlang\\}\\{mlang en\\}Germany\\{mlang\\}\\{mlang ca\\}Alemanya\\{mlang\\} -> \\{mlang es\\}Berl√≠n\\{mlang\\}\\{mlang en\\}Berlin\\{mlang\\}\\{mlang ca\\}Berl√≠n\\{mlang\\}
}

::Pregunta Num√©rica Simple::\\{mlang es\\}¬øCu√°l es el valor de pi con tres decimales?\\{mlang\\}\\{mlang en\\}What is the value of pi to three decimal places?\\{mlang\\}\\{mlang ca\\}Quin √©s el valor de pi amb tres decimals?\\{mlang\\}{#3.14159:0.0005}

::Pregunta Num√©rica con Rango::\\{mlang es\\}¬øCu√°ndo naci√≥ Ulysses S. Grant (rango de 5 a√±os)?\\{mlang\\}\\{mlang en\\}When was Ulysses S. Grant born (5 year range)?\\{mlang\\}\\{mlang ca\\}Quan va n√©ixer Ulysses S. Grant (rang de 5 anys)?\\{mlang\\}{#1822:5}

::Pregunta Num√©rica con Cr√©dito Parcial::\\{mlang es\\}¬øEn qu√© a√±o se descubri√≥ Am√©rica?\\{mlang\\}\\{mlang en\\}In what year was America discovered?\\{mlang\\}\\{mlang ca\\}En quin any es va descobrir Am√®rica?\\{mlang\\}{#
=1492:0
=%50%1822:2
}

::Pregunta de Ensayo::\\{mlang es\\}Explica la importancia de la Revoluci√≥n Francesa en la historia europea.\\{mlang\\}\\{mlang en\\}Explain the importance of the French Revolution in European history.\\{mlang\\}\\{mlang ca\\}Explica la import√†ncia de la Revoluci√≥ Francesa en la hist√≤ria europea.\\{mlang\\}{}

::Palabra Perdida::\\{mlang es\\}Isaac Newton es famoso por formular la ley de la\\{mlang\\}\\{mlang en\\}Isaac Newton is famous for formulating the law of\\{mlang\\}\\{mlang ca\\}Isaac Newton √©s fam√≥s per formular la llei de la\\{mlang\\} {
=\\{mlang es\\}gravitaci√≥n\\{mlang\\}\\{mlang en\\}gravitation\\{mlang\\}\\{mlang ca\\}gravitaci√≥\\{mlang\\}
=\\{mlang es\\}gravedad\\{mlang\\}\\{mlang en\\}gravity\\{mlang\\}\\{mlang ca\\}gravetat\\{mlang\\}
=\\{mlang es\\}gravitaci√≥n universal\\{mlang\\}\\{mlang en\\}universal gravitation\\{mlang\\}\\{mlang ca\\}gravitaci√≥ universal\\{mlang\\}
}.`;

    document.getElementById('giftInput').value = example;
    parseGIFT();
}
        function clearAll() {
            document.getElementById('giftInput').value = '';
            document.getElementById('output').innerHTML = '';
            detectedContentLanguages.clear();
            updateContentLanguageSelector();
            document.getElementById('detectedLanguagesInfo').innerHTML = '';
            questionLanguageOverrides = {};
            editedQuestions = {};
            document.getElementById('exportSection').classList.remove('visible');
        }

        window.addEventListener('load', () => {
            detectBrowserLanguage();
        });
    </script>
</body>
</html>
